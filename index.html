<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cortex Vitrasa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Outfit', sans-serif;
    }
    .bus-pattern {
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255,193,7,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0,150,136,0.1) 0%, transparent 50%),
        linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    }
    .card-glow {
      box-shadow: 0 0 30px rgba(255,193,7,0.2), 0 10px 40px rgba(0,0,0,0.3);
    }
    .btn-primary {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255,193,7,0.4);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #009688 0%, #00796b 100%);
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,150,136,0.4);
    }
    .bus-card {
      background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
      border-left: 5px solid #ffc107;
      transition: all 0.3s ease;
    }
    .bus-card:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .bus-card.selected {
      border-left-color: #009688;
      background: linear-gradient(145deg, #e0f2f1 0%, #b2dfdb 100%);
    }
    .bus-card.correct {
      border-left-color: #4caf50;
      background: linear-gradient(145deg, #c8e6c9 0%, #a5d6a7 100%);
      animation: pulse-green 0.5s ease;
    }
    .bus-card.incorrect {
      border-left-color: #f44336;
      background: linear-gradient(145deg, #ffcdd2 0%, #ef9a9a 100%);
      animation: shake 0.5s ease;
    }
    @keyframes pulse-green {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    .timer-bar {
      transition: width 0.1s linear;
    }
    .memory-card {
      perspective: 1000px;
      cursor: pointer;
    }
    .memory-card-inner {
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .memory-card.flipped .memory-card-inner {
      transform: rotateY(180deg);
    }
    .memory-card-front, .memory-card-back {
      backface-visibility: hidden;
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 12px;
    }
    .memory-card-back {
      transform: rotateY(180deg);
    }
    .route-line {
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: drawLine 2s ease forwards;
    }
    @keyframes drawLine {
      to { stroke-dashoffset: 0; }
    }
    .leaderboard-row {
      animation: slideIn 0.3s ease forwards;
      opacity: 0;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .challenge-icon {
      transition: all 0.3s ease;
    }
    .challenge-icon:hover {
      transform: scale(1.1) rotate(5deg);
    }
    .streak-fire {
      animation: fireGlow 0.5s ease infinite alternate;
    }
    @keyframes fireGlow {
      from { text-shadow: 0 0 10px #ff9800, 0 0 20px #ff5722; }
      to { text-shadow: 0 0 20px #ff9800, 0 0 40px #ff5722; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bus-pattern text-white overflow-auto"><!-- Pantalla de Carga -->
  <div id="screen-loader" class="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex flex-col items-center justify-center z-50"><img src="https://lucasmaneirodelatm-dot.github.io/cortex/img/Loader.gif" alt="Cargando..." class="w-32 h-32 mb-4" loading="eager">
   <p class="text-xl font-semibold text-gray-300 animate-pulse">Cargando Cortex Vitrasa...</p>
  </div>
  <div id="app" class="h-full w-full p-4 md:p-6"><!-- Modal de Autenticaci√≥n -->
   <div id="auth-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-white/10">
     <h2 id="auth-modal-title" class="text-2xl font-bold mb-4 text-center">Crear Cuenta</h2>
     <div id="auth-form">
      <div class="mb-4"><label for="auth-username" class="block text-sm text-gray-300 mb-2">Nombre de usuario</label> <input type="text" id="auth-username" placeholder="Tu nombre..." class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400">
      </div>
      <div class="mb-4"><label for="auth-password" class="block text-sm text-gray-300 mb-2">Contrase√±a</label> <input type="password" id="auth-password" placeholder="Crea una contrase√±a..." class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400">
      </div>
      <div id="auth-error" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400 text-sm"></div><button id="auth-submit-btn" class="w-full btn-primary py-3 rounded-xl font-bold text-gray-900"> Crear Cuenta </button> <button id="auth-switch-btn" class="w-full mt-3 text-gray-400 hover:text-white transition text-sm"> ¬øYa tienes cuenta? Inicia sesi√≥n </button>
     </div>
    </div>
   </div><!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
   <div id="delete-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-white/10">
     <h2 class="text-2xl font-bold mb-4 text-center text-red-400">‚ö†Ô∏è Eliminar Cuenta</h2>
     <p class="text-gray-300 mb-6 text-center">¬øEst√°s seguro de que quieres eliminar tu cuenta? Esta acci√≥n no se puede deshacer.</p>
     <div class="flex gap-3"><button id="cancel-delete-btn" class="flex-1 btn-secondary py-3 rounded-xl font-bold text-white"> Cancelar </button> <button id="confirm-delete-btn" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold text-white transition"> Eliminar </button>
     </div>
    </div>
   </div><!-- Pantalla de Inicio -->
   <div id="screen-home" class="max-w-4xl mx-auto">
    <header class="text-center mb-8 fade-in">
     <div class="inline-block mb-4"><img src="https://lucasmaneirodelatm-dot.github.io/cortex/img/logo.png" alt="Logo Vitrasa" class="mx-auto h-24 w-auto" loading="lazy" onerror="console.error('Image failed to load:', this.src); this.style.display='none';">
     </div>
     <h1 id="main-title" class="text-4xl md:text-5xl font-extrabold mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">Cortex Vitrasa</h1>
     <p id="welcome-text" class="text-lg text-gray-300">¬°Pon a prueba tu mente con los buses de Vigo!</p>
    </header><!-- Stats del jugador -->
    <div id="player-stats" class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-6 fade-in" style="animation-delay: 0.1s">
     <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-2xl">
        üß†
       </div>
       <div>
        <p class="text-sm text-gray-400">Jugador</p>
        <p id="player-name-display" class="font-bold text-lg">An√≥nimo</p><button id="logout-btn" class="hidden text-xs text-red-400 hover:text-red-300 transition mt-1">Cerrar sesi√≥n</button>
       </div>
      </div>
      <div class="flex gap-6 text-center">
       <div>
        <p class="text-2xl font-bold text-yellow-400" id="stat-score">0</p>
        <p class="text-xs text-gray-400">Puntos</p>
       </div>
       <div>
        <p class="text-2xl font-bold text-teal-400" id="stat-games">0</p>
        <p class="text-xs text-gray-400">Partidas</p>
       </div>
       <div>
        <p class="text-2xl font-bold text-orange-400" id="stat-streak">0</p>
        <p class="text-xs text-gray-400">Mejor Racha</p>
       </div>
      </div><button id="delete-account-btn" class="hidden text-xs text-gray-500 hover:text-red-400 transition"> üóëÔ∏è Eliminar cuenta </button>
     </div>
    </div><!-- Registro de nombre -->
    <div id="name-input-section" class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-6 fade-in" style="animation-delay: 0.15s">
     <p class="text-sm text-gray-300 mb-2 text-center">Para guardar tu progreso en el ranking</p><button id="show-auth-btn" class="w-full btn-primary py-3 rounded-xl font-bold text-gray-900"> Crear Cuenta / Iniciar Sesi√≥n </button>
    </div><!-- Modos de juego -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6"><button onclick="startChallenge('memory')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.2s">
      <div class="text-4xl mb-2">
       üé¥
      </div><h3 class="font-bold text-sm">Memoria</h3><p class="text-xs text-gray-400">Recuerda las rutas</p></button> <button onclick="startChallenge('calculation')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.25s">
      <div class="text-4xl mb-2">
       üî¢
      </div><h3 class="font-bold text-sm">C√°lculo</h3><p class="text-xs text-gray-400">Billetes y cambio</p></button> <button onclick="startChallenge('routes')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.3s">
      <div class="text-4xl mb-2">
       ÔøΩÔøΩÔ∏è
      </div><h3 class="font-bold text-sm">Rutas</h3><p class="text-xs text-gray-400">¬øQu√© l√≠nea va?</p></button> <button onclick="startChallenge('sequence')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.35s">
      <div class="text-4xl mb-2">
       üîÑ
      </div><h3 class="font-bold text-sm">Secuencia</h3><p class="text-xs text-gray-400">Orden de paradas</p></button> <button onclick="startChallenge('speed')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.4s">
      <div class="text-4xl mb-2">
       ‚ö°
      </div><h3 class="font-bold text-sm">Velocidad</h3><p class="text-xs text-gray-400">Respuesta r√°pida</p></button> <button onclick="startChallenge('pairs')" class="challenge-icon bg-white/10 backdrop-blur rounded-2xl p-4 text-center hover:bg-white/20 fade-in" style="animation-delay: 0.45s">
      <div class="text-4xl mb-2">
       üëØ
      </div><h3 class="font-bold text-sm">Parejas</h3><p class="text-xs text-gray-400">Une l√≠nea y destino</p></button>
    </div><!-- Bot√≥n de juego mixto --> <button onclick="startMixedGame()" class="w-full btn-primary py-4 rounded-2xl font-bold text-xl text-gray-900 mb-6 fade-in" style="animation-delay: 0.5s"> üéÆ JUEGO MIXTO - 10 Rondas </button> <!-- Leaderboard -->
    <div class="bg-white/10 backdrop-blur rounded-2xl p-4 fade-in" style="animation-delay: 0.55s">
     <h2 class="text-xl font-bold mb-4 flex items-center gap-2">üèÜ Ranking de Viajeros</h2>
     <div id="leaderboard" class="space-y-2">
      <p class="text-gray-400 text-center py-4">A√∫n no hay puntuaciones. ¬°S√© el primero!</p>
     </div>
    </div>
   </div><!-- Pantalla de Juego -->
   <div id="screen-game" class="max-w-4xl mx-auto hidden"><!-- Header del juego -->
    <div class="flex items-center justify-between mb-4"><button onclick="exitGame()" class="flex items-center gap-2 text-gray-400 hover:text-white transition">
      <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" />
      </svg> Salir </button>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-1"><span id="current-streak" class="text-2xl font-bold text-orange-400">0</span> <span class="text-xl">üî•</span>
      </div>
      <div class="bg-white/20 rounded-full px-4 py-1"><span class="text-sm text-gray-300">Ronda</span> <span id="round-display" class="font-bold ml-1">1/10</span>
      </div>
     </div>
     <div class="text-right">
      <p class="text-2xl font-bold text-yellow-400" id="game-score">0</p>
      <p class="text-xs text-gray-400">puntos</p>
     </div>
    </div><!-- Barra de tiempo -->
    <div class="w-full h-2 bg-white/20 rounded-full mb-6 overflow-hidden">
     <div id="timer-bar" class="timer-bar h-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full" style="width: 100%"></div>
    </div><!-- √Årea del desaf√≠o -->
    <div id="challenge-area" class="bg-white/10 backdrop-blur rounded-2xl p-6 min-h-[400px]"><!-- El contenido del desaf√≠o se genera din√°micamente -->
    </div>
   </div><!-- Pantalla de Resultados -->
   <div id="screen-results" class="max-w-4xl mx-auto hidden">
    <div class="text-center py-8 fade-in">
     <div class="text-6xl mb-4">
      üéâ
     </div>
     <h2 class="text-3xl font-bold mb-2">¬°Partida Terminada!</h2>
     <p class="text-gray-300 mb-6">Has completado todos los desaf√≠os</p>
     <div class="bg-white/10 backdrop-blur rounded-2xl p-6 mb-6">
      <div class="grid grid-cols-3 gap-4 mb-6">
       <div class="text-center">
        <p class="text-4xl font-bold text-yellow-400" id="result-score">0</p>
        <p class="text-sm text-gray-400">Puntos</p>
       </div>
       <div class="text-center">
        <p class="text-4xl font-bold text-green-400" id="result-correct">0</p>
        <p class="text-sm text-gray-400">Aciertos</p>
       </div>
       <div class="text-center">
        <p class="text-4xl font-bold text-orange-400" id="result-streak">0</p>
        <p class="text-sm text-gray-400">Mejor Racha</p>
       </div>
      </div>
      <div id="result-message" class="text-lg font-semibold text-teal-400 mb-4">
       ¬°Buen trabajo!
      </div>
     </div>
     <div class="flex gap-4 justify-center"><button onclick="startMixedGame()" class="btn-primary px-8 py-3 rounded-xl font-bold text-gray-900"> üîÑ Jugar de Nuevo </button> <button onclick="showHome()" class="btn-secondary px-8 py-3 rounded-xl font-bold text-white"> üè† Inicio </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ==================== ALMACENAMIENTO COMPARTIDO GLOBAL ====================
    // Usamos JSONBin.io para un ranking compartido entre todos los usuarios
    
    const JSONBIN_CONFIG = {
      binId: '679253dee0b5fc4d7b408f9a',
      apiKey: '$2b$10$vqz0v1HcZ8F5H8rGX3gHyO3Y4Jz5F5Ey5vZ7F8Ry9Gz5Fy8Ez9Gz9G'
    };

    async function getGlobalData() {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_CONFIG.apiKey
          }
        });
        const data = await response.json();
        return data.record || { users: {} };
      } catch (error) {
        console.error('Error al cargar datos globales:', error);
        return { users: {} };
      }
    }

    async function setGlobalData(data) {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_CONFIG.apiKey
          },
          body: JSON.stringify(data)
        });
        return response.ok;
      } catch (error) {
        console.error('Error al guardar datos globales:', error);
        return false;
      }
    }

    function getLocalData(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch {
        return defaultValue;
      }
    }

    function setLocalData(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch {
        return false;
      }
    }

    // ==================== GESTI√ìN DE AUTENTICACI√ìN ====================
    let currentUser = null;
    let authMode = 'signup'; // 'signup' o 'login'

    // Verificar sesi√≥n al cargar
    function checkSession() {
      const sessionData = getLocalData('vitrasaSession');
      if (sessionData) {
        const now = Date.now();
        
        // Verificar si la sesi√≥n ha expirado (24 horas)
        if (now - sessionData.timestamp < 24 * 60 * 60 * 1000) {
          currentUser = sessionData.username;
          updateUIForLoggedInUser();
          return true;
        } else {
          localStorage.removeItem('vitrasaSession');
        }
      }
      return false;
    }

    // Crear sesi√≥n local (24h)
    function createSession(username) {
      const sessionData = {
        username: username,
        timestamp: Date.now()
      };
      setLocalData('vitrasaSession', sessionData);
    }

    // Actualizar UI cuando el usuario est√° logueado
    function updateUIForLoggedInUser() {
      const nameInputSection = document.getElementById('name-input-section');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteBtn = document.getElementById('delete-account-btn');
      
      if (nameInputSection) nameInputSection.classList.add('hidden');
      if (logoutBtn) logoutBtn.classList.remove('hidden');
      if (deleteBtn) deleteBtn.classList.remove('hidden');
      
      loadUserData();
    }

    // Mostrar modal de autenticaci√≥n
    function showAuthModal(mode = 'signup') {
      authMode = mode;
      const modal = document.getElementById('auth-modal');
      const title = document.getElementById('auth-modal-title');
      const submitBtn = document.getElementById('auth-submit-btn');
      const switchBtn = document.getElementById('auth-switch-btn');
      const usernameInput = document.getElementById('auth-username');
      const passwordInput = document.getElementById('auth-password');
      const errorDiv = document.getElementById('auth-error');
      
      if (mode === 'signup') {
        title.textContent = 'Crear Cuenta';
        submitBtn.textContent = 'Crear Cuenta';
        switchBtn.textContent = '¬øYa tienes cuenta? Inicia sesi√≥n';
        passwordInput.placeholder = 'Crea una contrase√±a...';
      } else {
        title.textContent = 'Iniciar Sesi√≥n';
        submitBtn.textContent = 'Iniciar Sesi√≥n';
        switchBtn.textContent = '¬øNo tienes cuenta? Cr√©ala';
        passwordInput.placeholder = 'Introduce tu contrase√±a...';
      }
      
      usernameInput.value = '';
      passwordInput.value = '';
      errorDiv.classList.add('hidden');
      modal.classList.remove('hidden');
    }

    // Ocultar modal de autenticaci√≥n
    function hideAuthModal() {
      const modal = document.getElementById('auth-modal');
      modal.classList.add('hidden');
    }

    // Mostrar error en el modal
    function showAuthError(message) {
      const errorDiv = document.getElementById('auth-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    // Hash simple de contrase√±a
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Crear cuenta
    async function signupUser(username, password) {
      if (!username || !password) {
        showAuthError('Por favor, completa todos los campos');
        return;
      }

      if (username.length < 3) {
        showAuthError('El nombre debe tener al menos 3 caracteres');
        return;
      }

      if (password.length < 6) {
        showAuthError('La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      try {
        // Mostrar loading
        const submitBtn = document.getElementById('auth-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando cuenta...';

        // Obtener todos los usuarios del servidor global
        const globalData = await getGlobalData();
        
        // Verificar si el usuario ya existe
        if (globalData.users[username]) {
          showAuthError('Este nombre de usuario ya est√° en uso');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear Cuenta';
          return;
        }

        // Crear usuario
        const hashedPassword = await hashPassword(password);
        globalData.users[username] = {
          password: hashedPassword,
          totalScore: 0,
          gamesPlayed: 0,
          bestStreak: 0,
          createdAt: Date.now()
        };
        
        // Guardar en el servidor global
        const saved = await setGlobalData(globalData);
        
        if (!saved) {
          showAuthError('Error de conexi√≥n. Int√©ntalo de nuevo.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear Cuenta';
          return;
        }

        currentUser = username;
        createSession(username);
        hideAuthModal();
        updateUIForLoggedInUser();
        showToast('¬°Cuenta creada exitosamente! üéâ');
        updateLeaderboard();

        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Cuenta';
      } catch (error) {
        console.error('Error al crear cuenta:', error);
        showAuthError('Error al crear la cuenta. Int√©ntalo de nuevo.');
        const submitBtn = document.getElementById('auth-submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Cuenta';
      }
    }

    // Iniciar sesi√≥n
    async function loginUser(username, password) {
      if (!username || !password) {
        showAuthError('Por favor, completa todos los campos');
        return;
      }

      try {
        // Mostrar loading
        const submitBtn = document.getElementById('auth-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Iniciando sesi√≥n...';

        // Obtener datos del servidor global
        const globalData = await getGlobalData();
        
        if (!globalData.users[username]) {
          showAuthError('Usuario no encontrado');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Iniciar Sesi√≥n';
          return;
        }

        const userData = globalData.users[username];
        const hashedPassword = await hashPassword(password);
        
        if (userData.password !== hashedPassword) {
          showAuthError('Contrase√±a incorrecta');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Iniciar Sesi√≥n';
          return;
        }

        currentUser = username;
        createSession(username);
        hideAuthModal();
        updateUIForLoggedInUser();
        showToast('¬°Bienvenido de nuevo! üëã');
        updateLeaderboard();

        submitBtn.disabled = false;
        submitBtn.textContent = 'Iniciar Sesi√≥n';
      } catch (error) {
        console.error('Error al iniciar sesi√≥n:', error);
        showAuthError('Error al iniciar sesi√≥n. Int√©ntalo de nuevo.');
        const submitBtn = document.getElementById('auth-submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Iniciar Sesi√≥n';
      }
    }

    // Cerrar sesi√≥n
    function logout() {
      localStorage.removeItem('vitrasaSession');
      currentUser = null;
      
      const nameInputSection = document.getElementById('name-input-section');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteBtn = document.getElementById('delete-account-btn');
      
      if (nameInputSection) nameInputSection.classList.remove('hidden');
      if (logoutBtn) logoutBtn.classList.add('hidden');
      if (deleteBtn) deleteBtn.classList.add('hidden');
      
      updatePlayerStats();
      showToast('Sesi√≥n cerrada');
    }

    // Mostrar modal de eliminaci√≥n de cuenta
    function showDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.remove('hidden');
    }

    // Ocultar modal de eliminaci√≥n de cuenta
    function hideDeleteModal() {
      const modal = document.getElementById('delete-modal');
      modal.classList.add('hidden');
    }

    // Eliminar cuenta
    async function deleteAccount() {
      if (!currentUser) return;

      try {
        // Obtener datos globales
        const globalData = await getGlobalData();
        delete globalData.users[currentUser];
        
        // Guardar en el servidor
        await setGlobalData(globalData);
        
        localStorage.removeItem('vitrasaSession');
        currentUser = null;
        
        hideDeleteModal();
        
        const nameInputSection = document.getElementById('name-input-section');
        const logoutBtn = document.getElementById('logout-btn');
        const deleteBtn = document.getElementById('delete-account-btn');
        
        if (nameInputSection) nameInputSection.classList.remove('hidden');
        if (logoutBtn) logoutBtn.classList.add('hidden');
        if (deleteBtn) deleteBtn.classList.add('hidden');
        
        updatePlayerStats();
        updateLeaderboard();
        showToast('Cuenta eliminada correctamente');
      } catch (error) {
        console.error('Error al eliminar cuenta:', error);
        showToast('Error al eliminar la cuenta');
      }
    }

    // Cargar datos del usuario
    async function loadUserData() {
      if (!currentUser) return;

      try {
        const globalData = await getGlobalData();
        if (globalData.users[currentUser]) {
          updatePlayerStats(globalData.users[currentUser]);
        }
      } catch (error) {
        console.error('Error al cargar datos:', error);
      }
    }

    // Guardar puntuaci√≥n
    async function saveScore(playerData) {
      if (!currentUser) {
        showToast('Crea una cuenta para guardar tu progreso');
        return;
      }

      try {
        // Obtener datos globales
        const globalData = await getGlobalData();
        
        if (globalData.users[currentUser]) {
          globalData.users[currentUser].totalScore += playerData.score;
          globalData.users[currentUser].gamesPlayed += 1;
          globalData.users[currentUser].bestStreak = Math.max(globalData.users[currentUser].bestStreak, playerData.bestStreak);
          globalData.users[currentUser].lastPlayed = Date.now();
          
          // Guardar en el servidor
          await setGlobalData(globalData);
          loadUserData();
          updateLeaderboard();
        }
      } catch (error) {
        console.error('Error al guardar puntuaci√≥n:', error);
        showToast('Error al guardar los datos');
      }
    }

    // ==================== DATOS DE VITRASA 2025 ====================
    const vitrasaData = {
      lines: [
        { number: 'C1', name: 'Circular Centro', color: '#e53935', 
          destinations: ['Praza de Am√©rica', 'Torrecedeira', 'Berb√©s', 'Policarpo Sanz', 'Praza de Espa√±a', 'R√∫a de Barcelona'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/C1.png' },
        { number: 'C3d', name: 'Bouzas/Coia - Encarnaci√≥n', color: '#FFEE58', 
          destinations: ['Bouzas', 'Coia', 'Torrecedeira', 'Encarnaci√≥n', 'Gran V√≠a'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3.png' },
        { number: 'C3i', name: 'Bouzas/Coia - Encarnaci√≥n', color: '#FDD835', 
          destinations: ['Bouzas', 'Coia', 'Gran V√≠a', 'Encarnaci√≥n', 'Torrecedeira'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3_dia-sin-coches.png' },
        { number: '5A', name: 'Navia - Trav. Vigo', color: '#1976D2', 
          destinations: ['Navia', 'Teis', 'Urz√°iz'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/5A.png' },
        { number: '5B', name: 'Navia - S. Bad√≠a', color: '#1565C0', 
          destinations: ['Navia', 'S. Bad√≠a', 'Teis', 'Urz√°iz'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/5B.png' },
        { number: '15C', name: 'Universidade - Samil', color: '#D1A3E0', 
          destinations: ['CUVI (Campus Universitario)', 'Berb√©s', 'Bouzas', 'Torrecedeira'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/15C.png' },
        { number: 'U1', name: 'Praza de Espa√±a - Fragoso - Universidade', color: '#795548', 
          destinations: ['CUVI (Campus Universitario)', 'Hospital √Ålvaro Cunqueiro', 'Praza de Espa√±a', 'Praza de Am√©rica', 'Castrelos'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/U1.png' }
      ],
      busImages: [
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/C1.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/5A.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/5B.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/articulado_p-espana.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/nueva-flota-solaris.png'
      ],
      stops: [
        'Praza de Am√©rica', 'Gran V√≠a', 'Urz√°iz', 'Policarpo Sanz', 'Praza de Espa√±a',
        'Torrecedeira', 'R√∫a de Barcelona', 'Berb√©s', 'Camelias', 'Castrelos',
        'Bouzas', 'Teis', 'Sai√°ns', 'Canido', 'CUVI (Campus Universitario)',
        'Navia', 'S. Bad√≠a', 'Arag√≥n', 'G. Espino', 'Encarnaci√≥n',
        'Hospital √Ålvaro Cunqueiro', 'Beade', 'Coia'
      ],
      prices: {
        ordinario: 1.63,
        passVigoGeneral: 0.56,
        passVigoEstudiante: 0.54,
        passVigoUniversitario: 0.42,
        passVigoSocial: 0.46
      }
    };

    // ==================== ESTADO DEL JUEGO ====================
    let gameState = {
      mode: 'mixed',
      round: 0,
      totalRounds: 10,
      score: 0,
      streak: 0,
      bestStreak: 0,
      correctAnswers: 0,
      timeLeft: 15,
      timerInterval: null,
      challenges: [],
      currentChallenge: null,
      memoryCards: [],
      flippedCards: [],
      matchedPairs: 0,
      isProcessing: false
    };

    // ==================== GESTI√ìN DE PUNTUACIONES GLOBALES ====================
    async function updateLeaderboard() {
      const container = document.getElementById('leaderboard');
      if (!container) return;

      try {
        // Mostrar loading
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Cargando ranking global...</p>';
        
        // Obtener datos del servidor global
        const globalData = await getGlobalData();
        
        if (!globalData.users || Object.keys(globalData.users).length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center py-4">A√∫n no hay puntuaciones. ¬°S√© el primero!</p>';
          return;
        }

        const leaderboard = Object.keys(globalData.users)
          .map(username => ({
            name: username,
            totalScore: globalData.users[username].totalScore || 0,
            gamesPlayed: globalData.users[username].gamesPlayed || 0,
            bestStreak: globalData.users[username].bestStreak || 0
          }))
          .sort((a, b) => b.totalScore - a.totalScore)
          .slice(0, 10);

        if (leaderboard.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center py-4">A√∫n no hay puntuaciones. ¬°S√© el primero!</p>';
          return;
        }
        
        container.innerHTML = leaderboard.map((player, index) => {
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
          const isCurrentPlayer = player.name === currentUser;
          
          return `
            <div class="leaderboard-row flex items-center justify-between p-3 rounded-xl ${isCurrentPlayer ? 'bg-yellow-500/20 border border-yellow-500/50' : 'bg-white/5'}" style="animation-delay: ${index * 0.05}s">
              <div class="flex items-center gap-3">
                <span class="text-xl w-8">${medal}</span>
                <span class="font-semibold ${isCurrentPlayer ? 'text-yellow-400' : ''}">${player.name}</span>
              </div>
              <div class="text-right">
                <span class="font-bold text-yellow-400">${player.totalScore}</span>
                <span class="text-xs text-gray-400 ml-1">pts</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error al cargar leaderboard:', error);
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Error al cargar el ranking. Refresca la p√°gina.</p>';
      }
    }

    function updatePlayerStats(userData = null) {
      const nameDisplay = document.getElementById('player-name-display');
      const scoreEl = document.getElementById('stat-score');
      const gamesEl = document.getElementById('stat-games');
      const streakEl = document.getElementById('stat-streak');

      if (currentUser && userData) {
        if (nameDisplay) nameDisplay.textContent = currentUser;
        if (scoreEl) scoreEl.textContent = userData.totalScore || 0;
        if (gamesEl) gamesEl.textContent = userData.gamesPlayed || 0;
        if (streakEl) streakEl.textContent = userData.bestStreak || 0;
      } else if (currentUser) {
        if (nameDisplay) nameDisplay.textContent = currentUser;
        loadUserData();
      } else {
        if (nameDisplay) nameDisplay.textContent = 'An√≥nimo';
        if (scoreEl) scoreEl.textContent = '0';
        if (gamesEl) gamesEl.textContent = '0';
        if (streakEl) streakEl.textContent = '0';
      }
    }

    // ==================== GESTI√ìN DE NOMBRE ====================
    // Ya no se usa - autenticaci√≥n con Firebase

    // ==================== NAVEGACI√ìN ====================
    function showScreen(screenId) {
      ['screen-home', 'screen-game', 'screen-results'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const screen = document.getElementById(screenId);
      if (screen) screen.classList.remove('hidden');
    }

    function showHome() {
      stopTimer();
      showScreen('screen-home');
      updateLeaderboard();
      updatePlayerStats();
    }

    function exitGame() {
      if (gameState.score > 0) {
        showResults();
      } else {
        showHome();
      }
    }

    // ==================== TOAST NOTIFICATIONS ====================
    function showToast(message, duration = 3000) {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg z-50 fade-in';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), duration);
    }

    // ==================== L√ìGICA DEL JUEGO ====================
    function startMixedGame() {
      gameState = {
        mode: 'mixed',
        round: 0,
        totalRounds: 10,
        score: 0,
        streak: 0,
        bestStreak: 0,
        correctAnswers: 0,
        timeLeft: 15,
        timerInterval: null,
        challenges: generateMixedChallenges(10),
        currentChallenge: null,
        memoryCards: [],
        flippedCards: [],
        matchedPairs: 0,
        isProcessing: false
      };

      showScreen('screen-game');
      nextRound();
    }

    function startChallenge(type) {
      gameState = {
        mode: type,
        round: 0,
        totalRounds: 5,
        score: 0,
        streak: 0,
        bestStreak: 0,
        correctAnswers: 0,
        timeLeft: 15,
        timerInterval: null,
        challenges: generateChallengesOfType(type, 5),
        currentChallenge: null,
        memoryCards: [],
        flippedCards: [],
        matchedPairs: 0,
        isProcessing: false
      };

      showScreen('screen-game');
      nextRound();
    }

    function generateMixedChallenges(count) {
      const types = ['memory', 'calculation', 'routes', 'sequence', 'speed', 'pairs'];
      const challenges = [];
      
      for (let i = 0; i < count; i++) {
        const type = types[i % types.length];
        challenges.push(generateChallenge(type));
      }
      
      return shuffleArray(challenges);
    }

    function generateChallengesOfType(type, count) {
      const challenges = [];
      for (let i = 0; i < count; i++) {
        challenges.push(generateChallenge(type));
      }
      return challenges;
    }

    function generateChallenge(type) {
      switch (type) {
        case 'memory': return generateMemoryChallenge();
        case 'calculation': return generateCalculationChallenge();
        case 'routes': return generateRoutesChallenge();
        case 'sequence': return generateSequenceChallenge();
        case 'speed': return generateSpeedChallenge();
        case 'pairs': return generatePairsChallenge();
        default: return generateSpeedChallenge();
      }
    }

    // ==================== GENERADORES DE DESAF√çOS ====================
    function generateMemoryChallenge() {
      const lines = shuffleArray([...vitrasaData.lines]).slice(0, 6);
      const pairs = lines.map(line => [
        { id: `line-${line.number}`, type: 'line', value: line.number, color: line.color, pairId: line.number },
        { id: `dest-${line.number}`, type: 'dest', value: line.destinations[0], color: line.color, pairId: line.number }
      ]).flat();
      
      return {
        type: 'memory',
        title: 'üé¥ Memoria de Rutas',
        instruction: 'Encuentra las parejas: l√≠nea con su destino principal',
        cards: shuffleArray(pairs),
        timeLimit: 45
      };
    }

    function generateCalculationChallenge() {
      const scenarios = [
        () => {
          const passengers = Math.floor(Math.random() * 5) + 2;
          const price = vitrasaData.prices.ordinario;
          return {
            question: `${passengers} pasajeros compran billete ordinario (${price}‚Ç¨ cada uno). ¬øCu√°nto pagan en total?`,
            answer: (passengers * price).toFixed(2),
            options: generateOptions((passengers * price).toFixed(2), 'money')
          };
        },
        () => {
          const paid = [5, 10, 20][Math.floor(Math.random() * 3)];
          const trips = Math.floor(Math.random() * 3) + 1;
          const cost = trips * vitrasaData.prices.ordinario;
          const change = paid - cost;
          return {
            question: `Pago ${paid}‚Ç¨ por ${trips} billete${trips > 1 ? 's' : ''} ordinario${trips > 1 ? 's' : ''} (${vitrasaData.prices.ordinario}‚Ç¨). ¬øCu√°nto me devuelven?`,
            answer: change.toFixed(2),
            options: generateOptions(change.toFixed(2), 'money')
          };
        },
        () => {
          const trips = Math.floor(Math.random() * 5) + 6;
          const passVigoPrice = vitrasaData.prices.passVigoGeneral;
          const ordinaryPrice = vitrasaData.prices.ordinario;
          const passCost = (trips * passVigoPrice).toFixed(2);
          const ordinaryCost = (trips * ordinaryPrice).toFixed(2);
          const savings = (ordinaryCost - passCost).toFixed(2);
          return {
            question: `¬øCu√°nto ahorro en ${trips} viajes con PassVigo General (${passVigoPrice}‚Ç¨/viaje) vs billete ordinario (${ordinaryPrice}‚Ç¨)?`,
            answer: savings,
            options: generateOptions(savings, 'money')
          };
        },
        () => {
          const studentPrice = vitrasaData.prices.passVigoEstudiante;
          const universityPrice = vitrasaData.prices.passVigoUniversitario;
          const difference = (studentPrice - universityPrice).toFixed(2);
          return {
            question: `¬øCu√°nto m√°s barata es la tarifa universitaria (${universityPrice}‚Ç¨) que la de estudiante (${studentPrice}‚Ç¨) por viaje?`,
            answer: difference,
            options: generateOptions(difference, 'money')
          };
        },
        () => {
          const trips = 20;
          const socialPrice = vitrasaData.prices.passVigoSocial;
          const total = (trips * socialPrice).toFixed(2);
          return {
            question: `Un usuario con tarifa PassVigo Social (${socialPrice}‚Ç¨/viaje) hace ${trips} viajes al mes. ¬øCu√°nto paga?`,
            answer: total,
            options: generateOptions(total, 'money')
          };
        }
      ];
      
      const scenario = scenarios[Math.floor(Math.random() * scenarios.length)]();
      
      return {
        type: 'calculation',
        title: 'üî¢ C√°lculo R√°pido',
        instruction: 'Resuelve el problema de tarifas',
        ...scenario,
        timeLimit: 20
      };
    }

    function generateRoutesChallenge() {
      const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
      const destination = line.destinations[Math.floor(Math.random() * line.destinations.length)];
      
      const wrongLines = vitrasaData.lines
        .filter(l => l.number !== line.number && !l.destinations.includes(destination))
        .slice(0, 3)
        .map(l => l.number);
      
      const options = shuffleArray([line.number, ...wrongLines]);
      
      return {
        type: 'routes',
        title: 'üó∫Ô∏è ¬øQu√© L√≠nea?',
        instruction: `¬øQu√© l√≠nea pasa por ${destination}?`,
        question: destination,
        answer: line.number,
        options: options,
        lineInfo: line,
        timeLimit: 12
      };
    }

    function generateSequenceChallenge() {
      const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
      const stops = [...line.destinations];
      const correctOrder = [...stops];
      const shuffledStops = shuffleArray([...stops]);
      
      return {
        type: 'sequence',
        title: 'üîÑ Orden de Paradas',
        instruction: `Ordena las paradas de la l√≠nea ${line.number}`,
        lineName: line.name,
        lineNumber: line.number,
        lineColor: line.color,
        stops: shuffledStops,
        correctOrder: correctOrder,
        timeLimit: 25
      };
    }

    function generateSpeedChallenge() {
      const types = ['color', 'destination', 'count'];
      const type = types[Math.floor(Math.random() * types.length)];
      
      if (type === 'color') {
        const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
        return {
          type: 'speed',
          subtype: 'color',
          title: '‚ö° Respuesta R√°pida',
          instruction: '¬øDe qu√© color es esta l√≠nea?',
          lineNumber: line.number,
          lineColor: line.color,
          answer: line.color,
          options: shuffleArray([line.color, ...getRandomColors(3, line.color)]),
          timeLimit: 8
        };
      } else if (type === 'destination') {
        const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
        const wrongDest = vitrasaData.stops.filter(s => !line.destinations.includes(s)).slice(0, 3);
        return {
          type: 'speed',
          subtype: 'destination',
          title: '‚ö° Respuesta R√°pida',
          instruction: `¬øCu√°l es un destino de la l√≠nea ${line.number}?`,
          lineNumber: line.number,
          answer: line.destinations[0],
          options: shuffleArray([line.destinations[0], ...wrongDest]),
          timeLimit: 10
        };
      } else {
        const count = Math.floor(Math.random() * 4) + 3;
        return {
          type: 'speed',
          subtype: 'count',
          title: '‚ö° Respuesta R√°pida',
          instruction: '¬øCu√°ntos buses ves?',
          busCount: count,
          answer: count.toString(),
          options: shuffleArray([count.toString(), (count-1).toString(), (count+1).toString(), (count+2).toString()]),
          timeLimit: 8
        };
      }
    }

    function generatePairsChallenge() {
      const selectedLines = shuffleArray([...vitrasaData.lines]).slice(0, 4);
      const pairs = selectedLines.map(line => ({
        line: line.number,
        destination: line.destinations[line.destinations.length - 1],
        color: line.color
      }));
      
      return {
        type: 'pairs',
        title: 'üëØ Une las Parejas',
        instruction: 'Conecta cada l√≠nea con su destino final',
        pairs: pairs,
        shuffledDestinations: shuffleArray(pairs.map(p => p.destination)),
        timeLimit: 20
      };
    }

    // ==================== RENDERIZADO DE DESAF√çOS ====================
    function renderChallenge(challenge) {
      const area = document.getElementById('challenge-area');
      if (!area) return;

      let html = `
        <div class="text-center mb-4">
          <h2 class="text-2xl font-bold mb-1">${challenge.title}</h2>
          <p class="text-gray-300">${challenge.instruction}</p>
        </div>
      `;

      switch (challenge.type) {
        case 'memory':
          html += renderMemoryChallenge(challenge);
          break;
        case 'calculation':
          html += renderCalculationChallenge(challenge);
          break;
        case 'routes':
          html += renderRoutesChallenge(challenge);
          break;
        case 'sequence':
          html += renderSequenceChallenge(challenge);
          break;
        case 'speed':
          html += renderSpeedChallenge(challenge);
          break;
        case 'pairs':
          html += renderPairsChallenge(challenge);
          break;
      }

      area.innerHTML = html;
      
      if (challenge.type === 'sequence') {
        initDragAndDrop();
      }
    }

    function renderMemoryChallenge(challenge) {
      gameState.memoryCards = challenge.cards;
      gameState.flippedCards = [];
      gameState.matchedPairs = 0;

      return `
        <div class="grid grid-cols-3 md:grid-cols-4 gap-3" id="memory-grid">
          ${challenge.cards.map((card, index) => `
            <div class="memory-card aspect-square" data-index="${index}" onclick="flipCard(${index})">
              <div class="memory-card-inner relative w-full h-full">
                <div class="memory-card-front bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center">
                  <span class="text-3xl">üöå</span>
                </div>
                <div class="memory-card-back bg-white flex flex-col items-center justify-center p-2">
                  ${card.type === 'line' ? `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background-color: ${card.color}">
                      ${card.value}
                    </div>
                    <p class="text-xs text-gray-600 mt-1">L√≠nea</p>
                  ` : `
                    <div class="w-3 h-3 rounded-full mb-1" style="background-color: ${card.color}"></div>
                    <p class="text-sm font-semibold text-gray-800 text-center">${card.value}</p>
                  `}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        <p class="text-center mt-4 text-gray-400">Parejas encontradas: <span id="pairs-count">0</span>/${challenge.cards.length / 2}</p>
      `;
    }

    function renderCalculationChallenge(challenge) {
      return `
        <div class="bg-white/10 rounded-xl p-6 mb-6">
          <p class="text-xl text-center">${challenge.question}</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => `
            <button onclick="checkAnswer('${option}')" class="bus-card rounded-xl p-4 text-center text-gray-800 text-2xl font-bold hover:scale-105 transition">
              ${option}‚Ç¨
            </button>
          `).join('')}
        </div>
      `;
    }

    function renderRoutesChallenge(challenge) {
      return `
        <div class="text-center mb-6">
          <div class="inline-block bg-white/20 rounded-2xl px-8 py-4">
            <p class="text-3xl font-bold">${challenge.question}</p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => {
            const line = vitrasaData.lines.find(l => l.number === option);
            return `
              <button onclick="checkAnswer('${option}')" class="bus-card rounded-xl p-4 flex flex-col items-center justify-center gap-2 hover:scale-105 transition">
                ${line && line.image ? `
                  <img src="${line.image}" alt="Bus l√≠nea ${option}" class="h-20 w-auto rounded-lg" loading="lazy" onerror="console.error('Image failed to load:', this.src); this.style.display='none';">
                ` : ''}
                <div class="flex items-center gap-2">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background-color: ${line?.color || '#666'}">
                    ${option}
                  </div>
                  <span class="text-gray-800 font-semibold">L√≠nea ${option}</span>
                </div>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderSequenceChallenge(challenge) {
      return `
        <div class="flex items-center justify-center gap-3 mb-6">
          <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl" style="background-color: ${challenge.lineColor}">
            ${challenge.lineNumber}
          </div>
          <span class="text-xl font-semibold">${challenge.lineName}</span>
        </div>
        <div id="sequence-container" class="space-y-2">
          ${challenge.stops.map((stop, index) => `
            <div class="sequence-item bus-card rounded-xl p-3 cursor-move flex items-center gap-3" data-stop="${stop}" draggable="true">
              <span class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold">${index + 1}</span>
              <span class="text-gray-800 font-semibold">${stop}</span>
              <span class="ml-auto text-gray-400">‚â°</span>
            </div>
          `).join('')}
        </div>
        <button onclick="checkSequence()" class="w-full mt-4 btn-primary py-3 rounded-xl font-bold text-gray-900">
          ‚úì Comprobar Orden
        </button>
      `;
    }

    function renderSpeedChallenge(challenge) {
      let visualContent = '';
      
      if (challenge.subtype === 'color') {
        const line = vitrasaData.lines.find(l => l.number === challenge.lineNumber);
        visualContent = `
          <div class="flex justify-center mb-6">
            ${line && line.image ? `
              <img src="${line.image}" alt="Bus l√≠nea ${challenge.lineNumber}" class="rounded-xl max-h-48 w-auto shadow-lg" loading="lazy" onerror="console.error('Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
              <div class="w-24 h-24 rounded-full flex items-center justify-center text-white font-bold text-4xl hidden" style="background-color: ${challenge.lineColor}">
                ${challenge.lineNumber}
              </div>
            ` : `
              <div class="w-24 h-24 rounded-full flex items-center justify-center text-white font-bold text-4xl" style="background-color: ${challenge.lineColor}">
                ${challenge.lineNumber}
              </div>
            `}
          </div>
        `;
      } else if (challenge.subtype === 'count') {
        const buses = [];
        const selectedImages = shuffleArray([...vitrasaData.busImages]).slice(0, challenge.busCount);
        for (let i = 0; i < challenge.busCount; i++) {
          buses.push(`
            <div class="transform" style="transform: rotate(${Math.random() * 10 - 5}deg)">
              <img src="${selectedImages[i]}" alt="Bus Vitrasa" class="h-16 w-auto rounded-lg shadow" loading="lazy" onerror="console.error('Image failed to load:', this.src); this.style.display='none';">
            </div>
          `);
        }
        visualContent = `
          <div class="flex flex-wrap justify-center gap-4 mb-6">
            ${buses.join('')}
          </div>
        `;
      }

      return `
        ${visualContent}
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => {
            if (challenge.subtype === 'color') {
              return `
                <button onclick="checkAnswer('${option}')" class="bus-card rounded-xl p-4 flex items-center justify-center gap-3 hover:scale-105 transition">
                  <div class="w-10 h-10 rounded-full" style="background-color: ${option}"></div>
                </button>
              `;
            } else {
              return `
                <button onclick="checkAnswer('${option}')" class="bus-card rounded-xl p-4 text-center text-gray-800 text-2xl font-bold hover:scale-105 transition">
                  ${option}
                </button>
              `;
            }
          }).join('')}
        </div>
      `;
    }

    function renderPairsChallenge(challenge) {
      gameState.selectedLine = null;
      gameState.pairsMatched = [];

      return `
        <div class="grid grid-cols-2 gap-6">
          <div class="space-y-3">
            <h3 class="text-center font-semibold text-gray-300 mb-2">L√≠neas</h3>
            ${challenge.pairs.map(pair => `
              <button onclick="selectLine('${pair.line}')" id="line-${pair.line}" 
                      class="w-full bus-card rounded-xl p-3 flex items-center gap-3 transition">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${pair.color}">
                  ${pair.line}
                </div>
                <span class="text-gray-800 font-semibold">L√≠nea ${pair.line}</span>
              </button>
            `).join('')}
          </div>
          <div class="space-y-3">
            <h3 class="text-center font-semibold text-gray-300 mb-2">Destinos</h3>
            ${challenge.shuffledDestinations.map(dest => `
              <button onclick="selectDestination('${dest}')" id="dest-${dest.replace(/\s+/g, '-')}" 
                      class="w-full bus-card rounded-xl p-3 text-center text-gray-800 font-semibold transition">
                ${dest}
              </button>
            `).join('')}
          </div>
        </div>
        <p class="text-center mt-4 text-gray-400">Parejas unidas: <span id="pairs-matched">0</span>/${challenge.pairs.length}</p>
      `;
    }

    // ==================== L√ìGICA DE MEMORIA ====================
    function flipCard(index) {
      if (gameState.isProcessing) return;
      if (gameState.flippedCards.includes(index)) return;
      if (gameState.flippedCards.length >= 2) return;

      const card = gameState.memoryCards[index];
      const cardEl = document.querySelectorAll('.memory-card')[index];
      
      if (cardEl.classList.contains('matched')) return;
      
      cardEl.classList.add('flipped');
      gameState.flippedCards.push(index);

      if (gameState.flippedCards.length === 2) {
        gameState.isProcessing = true;
        const [first, second] = gameState.flippedCards;
        const card1 = gameState.memoryCards[first];
        const card2 = gameState.memoryCards[second];

        if (card1.pairId === card2.pairId && card1.type !== card2.type) {
          setTimeout(() => {
            document.querySelectorAll('.memory-card')[first].classList.add('matched');
            document.querySelectorAll('.memory-card')[second].classList.add('matched');
            gameState.matchedPairs++;
            document.getElementById('pairs-count').textContent = gameState.matchedPairs;
            
            if (gameState.matchedPairs === gameState.memoryCards.length / 2) {
              handleCorrectAnswer(true);
            }
            
            gameState.flippedCards = [];
            gameState.isProcessing = false;
          }, 500);
        } else {
          setTimeout(() => {
            document.querySelectorAll('.memory-card')[first].classList.remove('flipped');
            document.querySelectorAll('.memory-card')[second].classList.remove('flipped');
            gameState.flippedCards = [];
            gameState.isProcessing = false;
          }, 1000);
        }
      }
    }

    // ==================== L√ìGICA DE SECUENCIA ====================
    function initDragAndDrop() {
      const container = document.getElementById('sequence-container');
      if (!container) return;

      let draggedItem = null;

      container.querySelectorAll('.sequence-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('opacity-50');
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('opacity-50');
          updateSequenceNumbers();
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(container, e.clientY);
          if (afterElement) {
            container.insertBefore(draggedItem, afterElement);
          } else {
            container.appendChild(draggedItem);
          }
        });
      });
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll('.sequence-item:not(.opacity-50)')];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateSequenceNumbers() {
      const items = document.querySelectorAll('.sequence-item');
      items.forEach((item, index) => {
        item.querySelector('span').textContent = index + 1;
      });
    }

    function checkSequence() {
      const items = document.querySelectorAll('.sequence-item');
      const userOrder = [...items].map(item => item.dataset.stop);
      const correctOrder = gameState.currentChallenge.correctOrder;
      
      const isCorrect = JSON.stringify(userOrder) === JSON.stringify(correctOrder);
      
      items.forEach((item, index) => {
        if (userOrder[index] === correctOrder[index]) {
          item.classList.add('correct');
        } else {
          item.classList.add('incorrect');
        }
      });

      setTimeout(() => {
        handleCorrectAnswer(isCorrect);
      }, 1000);
    }

    // ==================== L√ìGICA DE PAREJAS ====================
    function selectLine(lineNumber) {
      document.querySelectorAll('[id^="line-"]').forEach(el => el.classList.remove('selected'));
      document.getElementById(`line-${lineNumber}`).classList.add('selected');
      gameState.selectedLine = lineNumber;
    }

    function selectDestination(destination) {
      if (!gameState.selectedLine) {
        showToast('Primero selecciona una l√≠nea');
        return;
      }

      const pair = gameState.currentChallenge.pairs.find(p => p.line === gameState.selectedLine);
      const isCorrect = pair && pair.destination === destination;

      const lineEl = document.getElementById(`line-${gameState.selectedLine}`);
      const destEl = document.getElementById(`dest-${destination.replace(/\s+/g, '-')}`);

      if (isCorrect) {
        lineEl.classList.add('correct');
        destEl.classList.add('correct');
        lineEl.disabled = true;
        destEl.disabled = true;
        
        if (!gameState.pairsMatched) gameState.pairsMatched = [];
        gameState.pairsMatched.push(gameState.selectedLine);
        document.getElementById('pairs-matched').textContent = gameState.pairsMatched.length;

        if (gameState.pairsMatched.length === gameState.currentChallenge.pairs.length) {
          setTimeout(() => handleCorrectAnswer(true), 500);
        }
      } else {
        lineEl.classList.add('incorrect');
        destEl.classList.add('incorrect');
        setTimeout(() => {
          lineEl.classList.remove('incorrect', 'selected');
          destEl.classList.remove('incorrect');
        }, 500);
      }

      gameState.selectedLine = null;
    }

    // ==================== COMPROBACI√ìN DE RESPUESTAS ====================
    function checkAnswer(answer) {
      const challenge = gameState.currentChallenge;
      const isCorrect = answer === challenge.answer || answer === challenge.answer.toString();
      
      const buttons = document.querySelectorAll('.bus-card');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent.includes(challenge.answer) || btn.querySelector(`[style*="${challenge.answer}"]`)) {
          btn.classList.add('correct');
        } else if (btn.textContent.includes(answer) || btn.onclick?.toString().includes(answer)) {
          if (!isCorrect) btn.classList.add('incorrect');
        }
      });

      setTimeout(() => handleCorrectAnswer(isCorrect), 800);
    }

    function handleCorrectAnswer(isCorrect) {
      stopTimer();

      if (isCorrect) {
        const timeBonus = Math.floor(gameState.timeLeft * 2);
        const points = 100 + timeBonus;
        gameState.score += points;
        gameState.streak++;
        gameState.correctAnswers++;
        gameState.bestStreak = Math.max(gameState.bestStreak, gameState.streak);
        
        showToast(`¬°Correcto! +${points} puntos üéâ`);
      } else {
        gameState.streak = 0;
        showToast('¬°Incorrecto! üòÖ');
      }

      updateGameUI();

      setTimeout(() => {
        if (gameState.round < gameState.totalRounds) {
          nextRound();
        } else {
          showResults();
        }
      }, 1500);
    }

    // ==================== CONTROL DE RONDAS ====================
    function nextRound() {
      gameState.round++;
      gameState.currentChallenge = gameState.challenges[gameState.round - 1];
      gameState.timeLeft = gameState.currentChallenge.timeLimit;

      updateGameUI();
      renderChallenge(gameState.currentChallenge);
      startTimer();
    }

    function updateGameUI() {
      document.getElementById('game-score').textContent = gameState.score;
      document.getElementById('round-display').textContent = `${gameState.round}/${gameState.totalRounds}`;
      document.getElementById('current-streak').textContent = gameState.streak;
      
      const streakEl = document.getElementById('current-streak');
      if (gameState.streak >= 3) {
        streakEl.classList.add('streak-fire');
      } else {
        streakEl.classList.remove('streak-fire');
      }
    }

    // ==================== TEMPORIZADOR ====================
    function startTimer() {
      const timerBar = document.getElementById('timer-bar');
      const totalTime = gameState.currentChallenge.timeLimit;
      
      gameState.timerInterval = setInterval(() => {
        gameState.timeLeft -= 0.1;
        const percentage = (gameState.timeLeft / totalTime) * 100;
        timerBar.style.width = `${Math.max(0, percentage)}%`;
        
        if (gameState.timeLeft <= 0) {
          stopTimer();
          handleCorrectAnswer(false);
        }
      }, 100);
    }

    function stopTimer() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
    }

    // ==================== RESULTADOS ====================
    function showResults() {
      stopTimer();
      
      document.getElementById('result-score').textContent = gameState.score;
      document.getElementById('result-correct').textContent = gameState.correctAnswers;
      document.getElementById('result-streak').textContent = gameState.bestStreak;

      let message = '';
      if (gameState.score >= 800) {
        message = 'üèÜ ¬°Eres un experto de Vitrasa!';
      } else if (gameState.score >= 500) {
        message = 'üåü ¬°Muy buen trabajo, viajero!';
      } else if (gameState.score >= 300) {
        message = 'ÔøΩÔøΩ ¬°Buen comienzo! Sigue practicando.';
      } else {
        message = 'üöå ¬°A seguir conociendo las rutas!';
      }
      document.getElementById('result-message').textContent = message;

      // Guardar puntuaci√≥n
      if (currentUser) {
        saveScore({
          score: gameState.score,
          bestStreak: gameState.bestStreak
        });
      }

      showScreen('screen-results');
    }

    // ==================== UTILIDADES ====================
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateOptions(correct, type) {
      const correctNum = parseFloat(correct);
      let options = [correct];
      
      while (options.length < 4) {
        let variation;
        if (type === 'money') {
          variation = (correctNum + (Math.random() * 4 - 2)).toFixed(2);
        } else {
          variation = Math.floor(correctNum + Math.random() * 10 - 5).toString();
        }
        if (!options.includes(variation) && parseFloat(variation) > 0) {
          options.push(variation);
        }
      }
      
      return shuffleArray(options);
    }

    function getRandomColors(count, exclude) {
      const colors = ['#e53935', '#1e88e5', '#43a047', '#fb8c00', '#8e24aa', '#00acc1', '#d81b60', '#5e35b1', '#00897b', '#c0ca33', '#6d4c41', '#546e7a'];
      return shuffleArray(colors.filter(c => c !== exclude)).slice(0, count);
    }

    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', () => {
      // Ocultar loader despu√©s de 2 segundos
      setTimeout(() => {
        const loader = document.getElementById('screen-loader');
        if (loader) {
          loader.style.opacity = '0';
          loader.style.transition = 'opacity 0.5s ease';
          setTimeout(() => loader.remove(), 500);
        }
      }, 2000);

      // Verificar sesi√≥n existente
      checkSession();
      
      // Cargar leaderboard inicial
      updateLeaderboard();
      updatePlayerStats();

      // Event listeners para autenticaci√≥n
      const showAuthBtn = document.getElementById('show-auth-btn');
      const authSubmitBtn = document.getElementById('auth-submit-btn');
      const authSwitchBtn = document.getElementById('auth-switch-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
      const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

      if (showAuthBtn) {
        showAuthBtn.addEventListener('click', () => showAuthModal('signup'));
      }

      if (authSubmitBtn) {
        authSubmitBtn.addEventListener('click', async () => {
          const username = document.getElementById('auth-username').value.trim();
          const password = document.getElementById('auth-password').value;
          
          if (authMode === 'signup') {
            await signupUser(username, password);
          } else {
            await loginUser(username, password);
          }
        });
      }

      if (authSwitchBtn) {
        authSwitchBtn.addEventListener('click', () => {
          const newMode = authMode === 'signup' ? 'login' : 'signup';
          showAuthModal(newMode);
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }

      if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', showDeleteModal);
      }

      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
      }

      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', deleteAccount);
      }

      // Permitir Enter en los campos de autenticaci√≥n
      const authPassword = document.getElementById('auth-password');
      if (authPassword) {
        authPassword.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            authSubmitBtn.click();
          }
        });
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7b66abd22dd929',t:'MTc3MDA1MzI2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
