<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cortex Vitrasa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&amp;family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Inter', sans-serif;
    }
    .title-font {
      font-family: 'Orbitron', sans-serif;
    }
    .game-bg {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2d1b4e 100%);
      position: relative;
      overflow: hidden;
    }
    .game-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(138, 43, 226, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    .neon-card {
      background: rgba(26, 31, 58, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(138, 43, 226, 0.3);
      box-shadow: 0 8px 32px rgba(138, 43, 226, 0.2);
      transition: all 0.3s ease;
    }
    .neon-card:hover {
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 8px 32px rgba(138, 43, 226, 0.4);
      transform: translateY(-2px);
    }
    .neon-btn {
      background: linear-gradient(135deg, #8a2be2 0%, #9d4edd 100%);
      box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .neon-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    .neon-btn:hover::before {
      left: 100%;
    }
    .neon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
    }
    .gold-btn {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      color: #0a0e27;
    }
    .gold-btn:hover {
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
    }
    .challenge-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(240,240,240,0.95) 100%);
      border-left: 4px solid #8a2be2;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .challenge-card:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(138, 43, 226, 0.3);
    }
    .challenge-card.selected {
      border-left-color: #ffd700;
      background: linear-gradient(145deg, #fff9e6 0%, #fff3cc 100%);
    }
    .challenge-card.correct {
      border-left-color: #10b981;
      background: linear-gradient(145deg, #d1fae5 0%, #a7f3d0 100%);
      animation: pulse-success 0.5s ease;
    }
    .challenge-card.incorrect {
      border-left-color: #ef4444;
      background: linear-gradient(145deg, #fee2e2 0%, #fecaca 100%);
      animation: shake 0.5s ease;
    }
    @keyframes pulse-success {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .timer-bar {
      transition: width 0.1s linear;
      background: linear-gradient(90deg, #10b981 0%, #ffd700 50%, #ef4444 100%);
    }
    .memory-card {
      perspective: 1000px;
      cursor: pointer;
    }
    .memory-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .memory-card.flipped .memory-card-inner {
      transform: rotateY(180deg);
    }
    .memory-card-front, .memory-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .memory-card-front {
      background: linear-gradient(135deg, #8a2be2 0%, #9d4edd 100%);
    }
    .memory-card-back {
      background: white;
      transform: rotateY(180deg);
    }
    .memory-card.matched .memory-card-inner {
      opacity: 0.6;
    }
    .leaderboard-row {
      animation: slideIn 0.4s ease forwards;
      opacity: 0;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .stat-badge {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.2) 0%, rgba(157, 78, 221, 0.2) 100%);
      border: 1px solid rgba(138, 43, 226, 0.4);
    }
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10, 14, 39, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      border-radius: 9999px;
      box-shadow: 0 8px 32px rgba(138, 43, 226, 0.4);
      border: 1px solid rgba(138, 43, 226, 0.5);
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full game-bg text-white overflow-auto"><!-- Modal de Autenticaci√≥n -->
  <div id="auth-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
   <div class="neon-card rounded-3xl p-8 max-w-md w-full">
    <h2 id="auth-modal-title" class="text-3xl font-bold mb-6 text-center title-font">Crear Cuenta</h2>
    <div id="auth-form">
     <div class="mb-5"><label for="auth-username" class="block text-sm text-gray-300 mb-2 font-medium">Nombre de usuario</label> <input type="text" id="auth-username" placeholder="Elige tu nombre..." class="w-full px-4 py-3 rounded-xl bg-white/10 border border-purple-500/30 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition">
     </div>
     <div class="mb-5"><label for="auth-password" class="block text-sm text-gray-300 mb-2 font-medium">Contrase√±a</label> <input type="password" id="auth-password" placeholder="Crea una contrase√±a segura..." class="w-full px-4 py-3 rounded-xl bg-white/10 border border-purple-500/30 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 transition">
     </div>
     <div id="auth-error" class="hidden mb-4 p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-300 text-sm"></div><button id="auth-submit-btn" class="w-full neon-btn py-4 rounded-xl font-bold text-white text-lg mb-3"> Crear Cuenta </button> <button id="auth-switch-btn" class="w-full text-gray-400 hover:text-purple-400 transition text-sm"> ¬øYa tienes cuenta? Inicia sesi√≥n </button>
    </div>
   </div>
  </div><!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
  <div id="delete-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
   <div class="neon-card rounded-3xl p-8 max-w-md w-full">
    <h2 class="text-3xl font-bold mb-4 text-center text-red-400 title-font">‚ö†Ô∏è Eliminar Cuenta</h2>
    <p class="text-gray-300 mb-6 text-center">¬øEst√°s seguro? Perder√°s todo tu progreso y puntuaci√≥n.</p>
    <div class="flex gap-4"><button id="cancel-delete-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-xl font-bold text-white transition"> Cancelar </button> <button id="confirm-delete-btn" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-xl font-bold text-white transition"> Eliminar </button>
    </div>
   </div>
  </div>
  <div id="app" class="h-full w-full p-4 md:p-8"><!-- Pantalla de Inicio -->
   <div id="screen-home" class="max-w-5xl mx-auto">
    <header class="text-center mb-10 fade-in">
     <h1 class="text-5xl md:text-7xl font-black mb-3 title-font bg-gradient-to-r from-purple-400 via-pink-400 to-yellow-400 bg-clip-text text-transparent">CORTEX VITRASA</h1>
     <p class="text-xl text-gray-300">üß† Pon a prueba tu mente con los buses de Vigo</p>
    </header><!-- Stats del jugador -->
    <div id="player-stats" class="neon-card rounded-2xl p-6 mb-8 fade-in" style="animation-delay: 0.1s">
     <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-4">
       <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl">
        üß†
       </div>
       <div>
        <p class="text-sm text-gray-400">Jugador</p>
        <p id="player-name-display" class="font-bold text-2xl">An√≥nimo</p><button id="logout-btn" class="hidden text-xs text-red-400 hover:text-red-300 transition mt-1">Cerrar sesi√≥n</button>
       </div>
      </div>
      <div class="flex gap-6">
       <div class="stat-badge px-4 py-3 rounded-xl text-center">
        <p class="text-3xl font-bold text-yellow-400" id="stat-score">0</p>
        <p class="text-xs text-gray-400">Puntos</p>
       </div>
       <div class="stat-badge px-4 py-3 rounded-xl text-center">
        <p class="text-3xl font-bold text-purple-400" id="stat-games">0</p>
        <p class="text-xs text-gray-400">Partidas</p>
       </div>
       <div class="stat-badge px-4 py-3 rounded-xl text-center">
        <p class="text-3xl font-bold text-pink-400" id="stat-streak">0</p>
        <p class="text-xs text-gray-400">Racha</p>
       </div>
      </div><button id="delete-account-btn" class="hidden text-xs text-gray-500 hover:text-red-400 transition"> üóëÔ∏è Eliminar cuenta </button>
     </div>
    </div><!-- Registro de nombre -->
    <div id="name-input-section" class="neon-card rounded-2xl p-6 mb-8 text-center fade-in" style="animation-delay: 0.15s">
     <p class="text-gray-300 mb-4">üíæ Guarda tu progreso y compite en el ranking global</p><button id="show-auth-btn" class="neon-btn px-8 py-3 rounded-xl font-bold text-white text-lg"> Crear Cuenta / Iniciar Sesi√≥n </button>
    </div><!-- Modos de juego -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"><button onclick="startChallenge('memory')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.2s">
      <div class="text-5xl mb-3">
       üé¥
      </div><h3 class="font-bold text-lg">Memoria</h3><p class="text-xs text-gray-400 mt-1">Parejas de l√≠neas</p></button> <button onclick="startChallenge('calculation')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.25s">
      <div class="text-5xl mb-3">
       üî¢
      </div><h3 class="font-bold text-lg">C√°lculo</h3><p class="text-xs text-gray-400 mt-1">Tarifas y cambio</p></button> <button onclick="startChallenge('routes')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.3s">
      <div class="text-5xl mb-3">
       üó∫Ô∏è
      </div><h3 class="font-bold text-lg">Rutas</h3><p class="text-xs text-gray-400 mt-1">Destinos correctos</p></button> <button onclick="startChallenge('sequence')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.35s">
      <div class="text-5xl mb-3">
       üîÑ
      </div><h3 class="font-bold text-lg">Secuencia</h3><p class="text-xs text-gray-400 mt-1">Orden de paradas</p></button> <button onclick="startChallenge('speed')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.4s">
      <div class="text-5xl mb-3">
       ‚ö°
      </div><h3 class="font-bold text-lg">Velocidad</h3><p class="text-xs text-gray-400 mt-1">Respuesta r√°pida</p></button> <button onclick="startChallenge('pairs')" class="neon-card rounded-2xl p-6 text-center hover:scale-105 transition fade-in" style="animation-delay: 0.45s">
      <div class="text-5xl mb-3">
       üëØ
      </div><h3 class="font-bold text-lg">Parejas</h3><p class="text-xs text-gray-400 mt-1">Une correctamente</p></button>
    </div><!-- Bot√≥n de juego mixto --> <button onclick="startMixedGame()" class="w-full gold-btn py-6 rounded-2xl font-bold text-2xl mb-8 fade-in" style="animation-delay: 0.5s"> üéÆ JUEGO COMPLETO - 10 Rondas </button> <!-- Leaderboard -->
    <div class="neon-card rounded-2xl p-6 fade-in" style="animation-delay: 0.55s">
     <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 title-font"><span class="text-3xl">üèÜ</span> Ranking Global</h2>
     <div id="leaderboard" class="space-y-2">
      <p class="text-gray-400 text-center py-8">Cargando ranking...</p>
     </div>
    </div>
   </div><!-- Pantalla de Juego -->
   <div id="screen-game" class="max-w-5xl mx-auto hidden"><!-- Header del juego -->
    <div class="flex items-center justify-between mb-6"><button onclick="exitGame()" class="flex items-center gap-2 text-gray-300 hover:text-white transition neon-card px-4 py-2 rounded-xl">
      <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" />
      </svg> Salir </button>
     <div class="flex items-center gap-4">
      <div class="stat-badge px-4 py-2 rounded-xl flex items-center gap-2"><span id="current-streak" class="text-3xl font-bold text-orange-400">0</span> <span class="text-2xl">üî•</span>
      </div>
      <div class="stat-badge px-4 py-2 rounded-xl"><span class="text-sm text-gray-400">Ronda</span> <span id="round-display" class="font-bold ml-2 text-lg">1/10</span>
      </div>
     </div>
     <div class="stat-badge px-4 py-2 rounded-xl text-right">
      <p class="text-3xl font-bold text-yellow-400" id="game-score">0</p>
      <p class="text-xs text-gray-400">puntos</p>
     </div>
    </div><!-- Barra de tiempo -->
    <div class="w-full h-3 bg-white/10 rounded-full mb-8 overflow-hidden">
     <div id="timer-bar" class="timer-bar h-full rounded-full" style="width: 100%"></div>
    </div><!-- √Årea del desaf√≠o -->
    <div id="challenge-area" class="neon-card rounded-2xl p-8 min-h-[500px]"><!-- Contenido din√°mico -->
    </div>
   </div><!-- Pantalla de Resultados -->
   <div id="screen-results" class="max-w-4xl mx-auto hidden">
    <div class="text-center py-12 fade-in">
     <div class="text-8xl mb-6">
      üéâ
     </div>
     <h2 class="text-5xl font-black mb-4 title-font">¬°Partida Terminada!</h2>
     <p class="text-xl text-gray-300 mb-10">Aqu√≠ est√°n tus resultados</p>
     <div class="neon-card rounded-2xl p-8 mb-8">
      <div class="grid grid-cols-3 gap-6 mb-8">
       <div class="text-center">
        <p class="text-5xl font-bold text-yellow-400 mb-2" id="result-score">0</p>
        <p class="text-sm text-gray-400">Puntos Totales</p>
       </div>
       <div class="text-center">
        <p class="text-5xl font-bold text-green-400 mb-2" id="result-correct">0</p>
        <p class="text-sm text-gray-400">Respuestas Correctas</p>
       </div>
       <div class="text-center">
        <p class="text-5xl font-bold text-orange-400 mb-2" id="result-streak">0</p>
        <p class="text-sm text-gray-400">Mejor Racha</p>
       </div>
      </div>
      <div id="result-message" class="text-2xl font-bold text-purple-400 mb-6">
       ¬°Excelente trabajo!
      </div>
     </div>
     <div class="flex gap-4 justify-center"><button onclick="startMixedGame()" class="neon-btn px-10 py-4 rounded-xl font-bold text-white text-lg"> üîÑ Jugar de Nuevo </button> <button onclick="showHome()" class="gold-btn px-10 py-4 rounded-xl font-bold text-lg"> üè† Inicio </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ==================== SISTEMA DE ALMACENAMIENTO LOCAL ROBUSTO ====================
    
    const STORAGE_KEYS = {
      USERS: 'cortex_vitrasa_users_v2',
      SESSION: 'cortex_vitrasa_session_v2'
    };

    // Gesti√≥n segura de localStorage
    function getLocalStorage(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (error) {
        console.error('Error al leer localStorage:', error);
        return defaultValue;
      }
    }

    function setLocalStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (error) {
        console.error('Error al guardar en localStorage:', error);
        return false;
      }
    }

    // Hash de contrase√±a simple pero efectivo
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'cortex_salt_2025');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Base de datos de usuarios local
    class UserDatabase {
      constructor() {
        this.users = getLocalStorage(STORAGE_KEYS.USERS, {});
      }

      save() {
        return setLocalStorage(STORAGE_KEYS.USERS, this.users);
      }

      userExists(username) {
        return username in this.users;
      }

      async createUser(username, password) {
        if (this.userExists(username)) {
          throw new Error('DUPLICATE_USER');
        }

        const hashedPassword = await hashPassword(password);
        this.users[username] = {
          username: username,
          password: hashedPassword,
          totalScore: 0,
          gamesPlayed: 0,
          bestStreak: 0,
          createdAt: new Date().toISOString(),
          lastPlayed: new Date().toISOString()
        };

        this.save();
        return this.users[username];
      }

      async validateUser(username, password) {
        if (!this.userExists(username)) {
          return null;
        }

        const hashedPassword = await hashPassword(password);
        const user = this.users[username];

        if (user.password === hashedPassword) {
          return user;
        }

        return null;
      }

      getUser(username) {
        return this.users[username] || null;
      }

      updateUser(username, updates) {
        if (!this.userExists(username)) {
          return false;
        }

        this.users[username] = {
          ...this.users[username],
          ...updates,
          lastPlayed: new Date().toISOString()
        };

        return this.save();
      }

      deleteUser(username) {
        if (!this.userExists(username)) {
          return false;
        }

        delete this.users[username];
        return this.save();
      }

      getLeaderboard(limit = 10) {
        return Object.values(this.users)
          .sort((a, b) => b.totalScore - a.totalScore)
          .slice(0, limit);
      }
    }

    const userDB = new UserDatabase();

    // ==================== GESTI√ìN DE SESI√ìN ====================
    
    let currentUser = null;
    let authMode = 'signup';

    function checkSession() {
      const sessionData = getLocalStorage(STORAGE_KEYS.SESSION);
      if (sessionData) {
        const now = Date.now();
        // Sesi√≥n v√°lida por 30 d√≠as
        if (now - sessionData.timestamp < 30 * 24 * 60 * 60 * 1000) {
          if (userDB.userExists(sessionData.username)) {
            currentUser = sessionData.username;
            updateUIForLoggedInUser();
            return true;
          }
        }
        localStorage.removeItem(STORAGE_KEYS.SESSION);
      }
      return false;
    }

    function createSession(username) {
      const sessionData = {
        username: username,
        timestamp: Date.now()
      };
      setLocalStorage(STORAGE_KEYS.SESSION, sessionData);
    }

    function destroySession() {
      localStorage.removeItem(STORAGE_KEYS.SESSION);
      currentUser = null;
    }

    // ==================== UI DE AUTENTICACI√ìN ====================

    function updateUIForLoggedInUser() {
      const nameInputSection = document.getElementById('name-input-section');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteBtn = document.getElementById('delete-account-btn');
      
      if (nameInputSection) nameInputSection.classList.add('hidden');
      if (logoutBtn) logoutBtn.classList.remove('hidden');
      if (deleteBtn) deleteBtn.classList.remove('hidden');
      
      loadUserData();
    }

    function showAuthModal(mode = 'signup') {
      authMode = mode;
      const modal = document.getElementById('auth-modal');
      const title = document.getElementById('auth-modal-title');
      const submitBtn = document.getElementById('auth-submit-btn');
      const switchBtn = document.getElementById('auth-switch-btn');
      const usernameInput = document.getElementById('auth-username');
      const passwordInput = document.getElementById('auth-password');
      const errorDiv = document.getElementById('auth-error');
      
      if (mode === 'signup') {
        title.textContent = 'Crear Cuenta';
        submitBtn.textContent = 'Crear Cuenta';
        switchBtn.textContent = '¬øYa tienes cuenta? Inicia sesi√≥n';
        passwordInput.placeholder = 'Crea una contrase√±a segura...';
      } else {
        title.textContent = 'Iniciar Sesi√≥n';
        submitBtn.textContent = 'Iniciar Sesi√≥n';
        switchBtn.textContent = '¬øNo tienes cuenta? Cr√©ala';
        passwordInput.placeholder = 'Introduce tu contrase√±a...';
      }
      
      usernameInput.value = '';
      passwordInput.value = '';
      errorDiv.classList.add('hidden');
      modal.classList.remove('hidden');
    }

    function hideAuthModal() {
      document.getElementById('auth-modal').classList.add('hidden');
    }

    function showAuthError(message) {
      const errorDiv = document.getElementById('auth-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    async function signupUser(username, password) {
      const submitBtn = document.getElementById('auth-submit-btn');
      
      username = username.trim();

      // Validaciones
      if (!username || !password) {
        showAuthError('‚ö†Ô∏è Por favor, completa todos los campos');
        return;
      }

      if (username.length < 3 || username.length > 20) {
        showAuthError('‚ö†Ô∏è El nombre debe tener entre 3 y 20 caracteres');
        return;
      }

      if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        showAuthError('‚ö†Ô∏è Solo letras, n√∫meros y guiones bajos permitidos');
        return;
      }

      if (password.length < 6) {
        showAuthError('‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando cuenta...';

        await userDB.createUser(username, password);

        currentUser = username;
        createSession(username);
        hideAuthModal();
        updateUIForLoggedInUser();
        showToast('‚úÖ ¬°Cuenta creada exitosamente!');
        
        setTimeout(() => updateLeaderboard(), 300);

        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Cuenta';
      } catch (error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Cuenta';
        
        if (error.message === 'DUPLICATE_USER') {
          showAuthError('‚ö†Ô∏è Este nombre de usuario ya est√° en uso');
        } else {
          showAuthError('‚ö†Ô∏è Error al crear la cuenta. Int√©ntalo de nuevo.');
        }
      }
    }

    async function loginUser(username, password) {
      const submitBtn = document.getElementById('auth-submit-btn');
      
      username = username.trim();

      if (!username || !password) {
        showAuthError('‚ö†Ô∏è Por favor, completa todos los campos');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Iniciando sesi√≥n...';

        const user = await userDB.validateUser(username, password);
        
        if (!user) {
          showAuthError('‚ö†Ô∏è Usuario o contrase√±a incorrectos');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Iniciar Sesi√≥n';
          return;
        }

        currentUser = username;
        createSession(username);
        hideAuthModal();
        updateUIForLoggedInUser();
        showToast('üëã ¬°Bienvenido de nuevo!');
        
        setTimeout(() => updateLeaderboard(), 300);

        submitBtn.disabled = false;
        submitBtn.textContent = 'Iniciar Sesi√≥n';
      } catch (error) {
        console.error('Error en login:', error);
        showAuthError('‚ö†Ô∏è Error de conexi√≥n. Int√©ntalo de nuevo.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Iniciar Sesi√≥n';
      }
    }

    function logout() {
      destroySession();
      
      const nameInputSection = document.getElementById('name-input-section');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteBtn = document.getElementById('delete-account-btn');
      
      if (nameInputSection) nameInputSection.classList.remove('hidden');
      if (logoutBtn) logoutBtn.classList.add('hidden');
      if (deleteBtn) deleteBtn.classList.add('hidden');
      
      updatePlayerStats();
      showToast('üëã Sesi√≥n cerrada');
    }

    function showDeleteModal() {
      document.getElementById('delete-modal').classList.remove('hidden');
    }

    function hideDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
    }

    function deleteAccount() {
      if (!currentUser) return;

      userDB.deleteUser(currentUser);
      destroySession();
      
      hideDeleteModal();
      
      const nameInputSection = document.getElementById('name-input-section');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteBtn = document.getElementById('delete-account-btn');
      
      if (nameInputSection) nameInputSection.classList.remove('hidden');
      if (logoutBtn) logoutBtn.classList.add('hidden');
      if (deleteBtn) deleteBtn.classList.add('hidden');
      
      updatePlayerStats();
      updateLeaderboard();
      showToast('üóëÔ∏è Cuenta eliminada correctamente');
    }

    // ==================== DATOS DEL JUGADOR ====================

    function loadUserData() {
      if (!currentUser) return;

      const userData = userDB.getUser(currentUser);
      if (userData) {
        updatePlayerStats(userData);
      }
    }

    function updatePlayerStats(userData = null) {
      const nameDisplay = document.getElementById('player-name-display');
      const scoreEl = document.getElementById('stat-score');
      const gamesEl = document.getElementById('stat-games');
      const streakEl = document.getElementById('stat-streak');

      if (currentUser && userData) {
        if (nameDisplay) nameDisplay.textContent = currentUser;
        if (scoreEl) scoreEl.textContent = userData.totalScore || 0;
        if (gamesEl) gamesEl.textContent = userData.gamesPlayed || 0;
        if (streakEl) streakEl.textContent = userData.bestStreak || 0;
      } else if (currentUser) {
        if (nameDisplay) nameDisplay.textContent = currentUser;
        loadUserData();
      } else {
        if (nameDisplay) nameDisplay.textContent = 'An√≥nimo';
        if (scoreEl) scoreEl.textContent = '0';
        if (gamesEl) gamesEl.textContent = '0';
        if (streakEl) streakEl.textContent = '0';
      }
    }

    function saveScore(scoreData) {
      if (!currentUser) {
        showToast('üíæ Crea una cuenta para guardar tu progreso');
        return;
      }

      const userData = userDB.getUser(currentUser);
      if (!userData) return;

      const updates = {
        totalScore: userData.totalScore + scoreData.score,
        gamesPlayed: userData.gamesPlayed + 1,
        bestStreak: Math.max(userData.bestStreak, scoreData.bestStreak)
      };

      userDB.updateUser(currentUser, updates);
      loadUserData();
      updateLeaderboard();
      showToast('üíæ ¬°Puntuaci√≥n guardada!');
    }

    // ==================== LEADERBOARD ====================

    function updateLeaderboard() {
      const container = document.getElementById('leaderboard');
      if (!container) return;

      const leaderboard = userDB.getLeaderboard(10);

      if (leaderboard.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">A√∫n no hay puntuaciones. ¬°S√© el primero!</p>';
        return;
      }

      container.innerHTML = leaderboard.map((player, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
        const isCurrentPlayer = player.username === currentUser;
        
        return `
          <div class="leaderboard-row flex items-center justify-between p-4 rounded-xl ${isCurrentPlayer ? 'bg-yellow-500/20 border border-yellow-500/50' : 'bg-white/5'}" style="animation-delay: ${index * 0.05}s">
            <div class="flex items-center gap-4">
              <span class="text-2xl w-10">${medal}</span>
              <div>
                <p class="font-bold text-lg ${isCurrentPlayer ? 'text-yellow-400' : 'text-white'}">${player.username}</p>
                <p class="text-xs text-gray-400">${player.gamesPlayed} partidas ‚Ä¢ Racha: ${player.bestStreak}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="font-bold text-2xl text-yellow-400">${player.totalScore}</span>
              <span class="text-sm text-gray-400 ml-1">pts</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== DATOS DE VITRASA ====================
    
    const vitrasaData = {
      lines: [
        { number: 'C1', name: 'Circular Centro', color: '#e53935', 
          destinations: ['Praza de Am√©rica', 'Torrecedeira', 'Berb√©s', 'Policarpo Sanz', 'Praza de Espa√±a', 'R√∫a de Barcelona'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/C1.png' },
        { number: 'C3d', name: 'Bouzas/Coia - Encarnaci√≥n', color: '#FFEE58', 
          destinations: ['Bouzas', 'Coia', 'Torrecedeira', 'Encarnaci√≥n', 'Gran V√≠a'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3.png' },
        { number: 'C3i', name: 'Bouzas/Coia - Encarnaci√≥n', color: '#FDD835', 
          destinations: ['Bouzas', 'Coia', 'Gran V√≠a', 'Encarnaci√≥n', 'Torrecedeira'],
          image: ' https://lucasmaneirodelatm-dot.github.io/cortex/img/C3_dia-sin-coches.png' },
        { number: '5A', name: 'Navia - Trav. Vigo', color: '#1976D2', 
          destinations: ['Navia', 'Teis', 'Urz√°iz'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/5A.png' },
        { number: '5B', name: 'Navia - S. Bad√≠a', color: '#1565C0', 
          destinations: ['Navia', 'S. Bad√≠a', 'Teis', 'Urz√°iz'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/5B.png' },
        { number: '15C', name: 'Universidade - Samil', color: '#D1A3E0', 
          destinations: ['CUVI (Campus Universitario)', 'Berb√©s', 'Bouzas', 'Torrecedeira'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/15C.png' },
        { number: 'U1', name: 'Praza de Espa√±a - Fragoso - Universidade', color: '#795548', 
          destinations: ['CUVI (Campus Universitario)', 'Hospital √Ålvaro Cunqueiro', 'Praza de Espa√±a', 'Praza de Am√©rica', 'Castrelos'],
          image: 'https://lucasmaneirodelatm-dot.github.io/cortex/img/U1.png' }
      ],
      busImages: [
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/C1.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/5A.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/5B.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/articulado_p-espana.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/nueva-flota-solaris.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/C3_dia-sin-coches.png',
        'https://lucasmaneirodelatm-dot.github.io/cortex/img/15C.png'
      ],
      stops: [
        'Praza de Am√©rica', 'Gran V√≠a', 'Urz√°iz', 'Policarpo Sanz', 'Praza de Espa√±a',
        'Torrecedeira', 'R√∫a de Barcelona', 'Berb√©s', 'Camelias', 'Castrelos',
        'Bouzas', 'Teis', 'Sai√°ns', 'Canido', 'CUVI (Campus Universitario)',
        'Navia', 'S. Bad√≠a', 'Arag√≥n', 'G. Espino', 'Encarnaci√≥n',
        'Hospital √Ålvaro Cunqueiro', 'Beade', 'Coia'
      ],
      prices: {
        ordinario: 1.63,
        passVigoGeneral: 0.56,
        passVigoEstudiante: 0.54,
        passVigoUniversitario: 0.42,
        passVigoSocial: 0.46
      }
    };

    // ==================== ESTADO DEL JUEGO ====================
    
    let gameState = {
      mode: 'mixed',
      round: 0,
      totalRounds: 10,
      score: 0,
      streak: 0,
      bestStreak: 0,
      correctAnswers: 0,
      timeLeft: 15,
      timerInterval: null,
      challenges: [],
      currentChallenge: null,
      memoryCards: [],
      flippedCards: [],
      matchedPairs: 0,
      isProcessing: false
    };

    // ==================== NAVEGACI√ìN ====================

    function showScreen(screenId) {
      ['screen-home', 'screen-game', 'screen-results'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const screen = document.getElementById(screenId);
      if (screen) screen.classList.remove('hidden');
    }

    function showHome() {
      stopTimer();
      showScreen('screen-home');
      updateLeaderboard();
      updatePlayerStats();
    }

    function exitGame() {
      if (gameState.score > 0) {
        showResults();
      } else {
        showHome();
      }
    }

    // ==================== TOAST NOTIFICATIONS ====================

    function showToast(message, duration = 3000) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), duration);
    }

    // ==================== L√ìGICA DEL JUEGO ====================

    function startMixedGame() {
      gameState = {
        mode: 'mixed',
        round: 0,
        totalRounds: 10,
        score: 0,
        streak: 0,
        bestStreak: 0,
        correctAnswers: 0,
        timeLeft: 15,
        timerInterval: null,
        challenges: generateMixedChallenges(10),
        currentChallenge: null,
        memoryCards: [],
        flippedCards: [],
        matchedPairs: 0,
        isProcessing: false
      };

      showScreen('screen-game');
      nextRound();
    }

    function startChallenge(type) {
      gameState = {
        mode: type,
        round: 0,
        totalRounds: 5,
        score: 0,
        streak: 0,
        bestStreak: 0,
        correctAnswers: 0,
        timeLeft: 15,
        timerInterval: null,
        challenges: generateChallengesOfType(type, 5),
        currentChallenge: null,
        memoryCards: [],
        flippedCards: [],
        matchedPairs: 0,
        isProcessing: false
      };

      showScreen('screen-game');
      nextRound();
    }

    function generateMixedChallenges(count) {
      const types = ['memory', 'calculation', 'routes', 'sequence', 'speed', 'pairs'];
      const challenges = [];
      
      for (let i = 0; i < count; i++) {
        const type = types[i % types.length];
        challenges.push(generateChallenge(type));
      }
      
      return shuffleArray(challenges);
    }

    function generateChallengesOfType(type, count) {
      const challenges = [];
      for (let i = 0; i < count; i++) {
        challenges.push(generateChallenge(type));
      }
      return challenges;
    }

    function generateChallenge(type) {
      switch (type) {
        case 'memory': return generateMemoryChallenge();
        case 'calculation': return generateCalculationChallenge();
        case 'routes': return generateRoutesChallenge();
        case 'sequence': return generateSequenceChallenge();
        case 'speed': return generateSpeedChallenge();
        case 'pairs': return generatePairsChallenge();
        default: return generateSpeedChallenge();
      }
    }

    // ==================== GENERADORES DE DESAF√çOS ====================

    function generateMemoryChallenge() {
      const lines = shuffleArray([...vitrasaData.lines]).slice(0, 6);
      const pairs = lines.map(line => [
        { id: `line-${line.number}`, type: 'line', value: line.number, color: line.color, pairId: line.number },
        { id: `dest-${line.number}`, type: 'dest', value: line.destinations[0], color: line.color, pairId: line.number }
      ]).flat();
      
      return {
        type: 'memory',
        title: 'üé¥ Memoria de Rutas',
        instruction: 'Encuentra las parejas: l√≠nea con su destino',
        cards: shuffleArray(pairs),
        timeLimit: 45
      };
    }

    function generateCalculationChallenge() {
      const scenarios = [
        () => {
          const passengers = Math.floor(Math.random() * 5) + 2;
          const price = vitrasaData.prices.ordinario;
          return {
            question: `${passengers} pasajeros pagan billete ordinario (${price}‚Ç¨). ¬øTotal?`,
            answer: (passengers * price).toFixed(2),
            options: generateOptions((passengers * price).toFixed(2), 'money')
          };
        },
        () => {
          const paid = [5, 10, 20][Math.floor(Math.random() * 3)];
          const trips = Math.floor(Math.random() * 3) + 1;
          const cost = trips * vitrasaData.prices.ordinario;
          const change = paid - cost;
          return {
            question: `Pago ${paid}‚Ç¨ por ${trips} billete(s) (${vitrasaData.prices.ordinario}‚Ç¨). ¬øCambio?`,
            answer: change.toFixed(2),
            options: generateOptions(change.toFixed(2), 'money')
          };
        }
      ];
      
      const scenario = scenarios[Math.floor(Math.random() * scenarios.length)]();
      
      return {
        type: 'calculation',
        title: 'üî¢ C√°lculo R√°pido',
        instruction: 'Resuelve el problema',
        ...scenario,
        timeLimit: 20
      };
    }

    function generateRoutesChallenge() {
      const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
      const destination = line.destinations[Math.floor(Math.random() * line.destinations.length)];
      
      const wrongLines = vitrasaData.lines
        .filter(l => l.number !== line.number)
        .slice(0, 3)
        .map(l => l.number);
      
      const options = shuffleArray([line.number, ...wrongLines]);
      
      return {
        type: 'routes',
        title: 'üó∫Ô∏è ¬øQu√© L√≠nea?',
        instruction: `¬øQu√© l√≠nea pasa por ${destination}?`,
        question: destination,
        answer: line.number,
        options: options,
        lineInfo: line,
        timeLimit: 12
      };
    }

    function generateSequenceChallenge() {
      const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
      const stops = [...line.destinations];
      const correctOrder = [...stops];
      const shuffledStops = shuffleArray([...stops]);
      
      return {
        type: 'sequence',
        title: 'üîÑ Orden de Paradas',
        instruction: `Ordena las paradas de la l√≠nea ${line.number}`,
        lineName: line.name,
        lineNumber: line.number,
        lineColor: line.color,
        stops: shuffledStops,
        correctOrder: correctOrder,
        timeLimit: 25
      };
    }

    function generateSpeedChallenge() {
      const line = vitrasaData.lines[Math.floor(Math.random() * vitrasaData.lines.length)];
      const wrongDest = vitrasaData.stops.filter(s => !line.destinations.includes(s)).slice(0, 3);
      
      return {
        type: 'speed',
        subtype: 'destination',
        title: '‚ö° Respuesta R√°pida',
        instruction: `¬øDestino de la l√≠nea ${line.number}?`,
        lineNumber: line.number,
        lineColor: line.color,
        answer: line.destinations[0],
        options: shuffleArray([line.destinations[0], ...wrongDest]),
        timeLimit: 10
      };
    }

    function generatePairsChallenge() {
      const selectedLines = shuffleArray([...vitrasaData.lines]).slice(0, 4);
      const pairs = selectedLines.map(line => ({
        line: line.number,
        destination: line.destinations[0],
        color: line.color
      }));
      
      return {
        type: 'pairs',
        title: 'üëØ Une las Parejas',
        instruction: 'Conecta l√≠nea con destino',
        pairs: pairs,
        shuffledDestinations: shuffleArray(pairs.map(p => p.destination)),
        timeLimit: 20
      };
    }

    // ==================== RENDERIZADO DE DESAF√çOS ====================

    function renderChallenge(challenge) {
      const area = document.getElementById('challenge-area');
      if (!area) return;

      let html = `
        <div class="text-center mb-6">
          <h2 class="text-3xl font-bold mb-2 title-font">${challenge.title}</h2>
          <p class="text-xl text-gray-300">${challenge.instruction}</p>
        </div>
      `;

      switch (challenge.type) {
        case 'memory':
          html += renderMemoryChallenge(challenge);
          break;
        case 'calculation':
          html += renderCalculationChallenge(challenge);
          break;
        case 'routes':
          html += renderRoutesChallenge(challenge);
          break;
        case 'sequence':
          html += renderSequenceChallenge(challenge);
          break;
        case 'speed':
          html += renderSpeedChallenge(challenge);
          break;
        case 'pairs':
          html += renderPairsChallenge(challenge);
          break;
      }

      area.innerHTML = html;
      
      if (challenge.type === 'sequence') {
        initDragAndDrop();
      }
    }

    function renderMemoryChallenge(challenge) {
      gameState.memoryCards = challenge.cards;
      gameState.flippedCards = [];
      gameState.matchedPairs = 0;

      return `
        <div class="grid grid-cols-3 md:grid-cols-4 gap-4" id="memory-grid">
          ${challenge.cards.map((card, index) => `
            <div class="memory-card aspect-square" data-index="${index}" onclick="flipCard(${index})">
              <div class="memory-card-inner">
                <div class="memory-card-front">
                  <span class="text-4xl">üöå</span>
                </div>
                <div class="memory-card-back">
                  ${card.type === 'line' ? `
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl" style="background-color: ${card.color}">
                      ${card.value}
                    </div>
                  ` : `
                    <div class="p-2 text-center">
                      <div class="w-4 h-4 rounded-full mx-auto mb-1" style="background-color: ${card.color}"></div>
                      <p class="text-sm font-bold text-gray-800">${card.value}</p>
                    </div>
                  `}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        <p class="text-center mt-6 text-xl">Parejas: <span id="pairs-count" class="font-bold text-yellow-400">0</span>/${challenge.cards.length / 2}</p>
      `;
    }

    function renderCalculationChallenge(challenge) {
      return `
        <div class="bg-white/10 rounded-2xl p-8 mb-8">
          <p class="text-2xl text-center font-semibold">${challenge.question}</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => `
            <button onclick="checkAnswer('${option}')" class="challenge-card rounded-2xl p-6 text-center text-gray-800 text-3xl font-bold">
              ${option}‚Ç¨
            </button>
          `).join('')}
        </div>
      `;
    }

    function renderRoutesChallenge(challenge) {
      return `
        <div class="text-center mb-8">
          <div class="inline-block bg-purple-500/20 rounded-2xl px-10 py-6 border border-purple-500/50">
            <p class="text-4xl font-bold">${challenge.question}</p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => {
            const line = vitrasaData.lines.find(l => l.number === option);
            return `
              <button onclick="checkAnswer('${option}')" class="challenge-card rounded-2xl p-6 flex flex-col items-center justify-center gap-3">
                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl" style="background-color: ${line?.color || '#666'}">
                  ${option}
                </div>
                <span class="text-gray-800 font-bold text-lg">L√≠nea ${option}</span>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderSequenceChallenge(challenge) {
      return `
        <div class="flex items-center justify-center gap-4 mb-8">
          <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl" style="background-color: ${challenge.lineColor}">
            ${challenge.lineNumber}
          </div>
          <span class="text-2xl font-bold">${challenge.lineName}</span>
        </div>
        <div id="sequence-container" class="space-y-3">
          ${challenge.stops.map((stop, index) => `
            <div class="sequence-item challenge-card rounded-xl p-4 cursor-move flex items-center gap-4" data-stop="${stop}" draggable="true">
              <span class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold">${index + 1}</span>
              <span class="text-gray-800 font-bold text-lg flex-1">${stop}</span>
              <span class="text-gray-400 text-xl">‚â°</span>
            </div>
          `).join('')}
        </div>
        <button onclick="checkSequence()" class="w-full mt-6 neon-btn py-4 rounded-xl font-bold text-white text-lg">
          ‚úì Comprobar Orden
        </button>
      `;
    }

    function renderSpeedChallenge(challenge) {
      return `
        <div class="text-center mb-8">
          <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center text-white font-bold text-3xl" style="background-color: ${challenge.lineColor}">
            ${challenge.lineNumber}
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          ${challenge.options.map(option => `
            <button onclick="checkAnswer('${option}')" class="challenge-card rounded-xl p-5 text-center text-gray-800 font-bold text-lg">
              ${option}
            </button>
          `).join('')}
        </div>
      `;
    }

    function renderPairsChallenge(challenge) {
      gameState.selectedLine = null;
      gameState.pairsMatched = [];

      return `
        <div class="grid grid-cols-2 gap-6">
          <div class="space-y-3">
            <h3 class="text-center font-bold text-xl text-gray-300 mb-4">L√≠neas</h3>
            ${challenge.pairs.map(pair => `
              <button onclick="selectLine('${pair.line}')" id="line-${pair.line}" 
                      class="w-full challenge-card rounded-xl p-4 flex items-center gap-3">
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background-color: ${pair.color}">
                  ${pair.line}
                </div>
                <span class="text-gray-800 font-bold">L√≠nea ${pair.line}</span>
              </button>
            `).join('')}
          </div>
          <div class="space-y-3">
            <h3 class="text-center font-bold text-xl text-gray-300 mb-4">Destinos</h3>
            ${challenge.shuffledDestinations.map(dest => `
              <button onclick="selectDestination('${dest}')" id="dest-${dest.replace(/\s+/g, '-')}" 
                      class="w-full challenge-card rounded-xl p-4 text-center text-gray-800 font-bold">
                ${dest}
              </button>
            `).join('')}
          </div>
        </div>
        <p class="text-center mt-6 text-xl">Parejas unidas: <span id="pairs-matched" class="font-bold text-yellow-400">0</span>/${challenge.pairs.length}</p>
      `;
    }

    // ==================== L√ìGICA DE MEMORIA ====================

    function flipCard(index) {
      if (gameState.isProcessing) return;
      if (gameState.flippedCards.includes(index)) return;
      if (gameState.flippedCards.length >= 2) return;

      const card = gameState.memoryCards[index];
      const cardEl = document.querySelectorAll('.memory-card')[index];
      
      if (cardEl.classList.contains('matched')) return;
      
      cardEl.classList.add('flipped');
      gameState.flippedCards.push(index);

      if (gameState.flippedCards.length === 2) {
        gameState.isProcessing = true;
        const [first, second] = gameState.flippedCards;
        const card1 = gameState.memoryCards[first];
        const card2 = gameState.memoryCards[second];

        if (card1.pairId === card2.pairId && card1.type !== card2.type) {
          setTimeout(() => {
            document.querySelectorAll('.memory-card')[first].classList.add('matched');
            document.querySelectorAll('.memory-card')[second].classList.add('matched');
            gameState.matchedPairs++;
            document.getElementById('pairs-count').textContent = gameState.matchedPairs;
            
            if (gameState.matchedPairs === gameState.memoryCards.length / 2) {
              handleCorrectAnswer(true);
            }
            
            gameState.flippedCards = [];
            gameState.isProcessing = false;
          }, 500);
        } else {
          setTimeout(() => {
            document.querySelectorAll('.memory-card')[first].classList.remove('flipped');
            document.querySelectorAll('.memory-card')[second].classList.remove('flipped');
            gameState.flippedCards = [];
            gameState.isProcessing = false;
          }, 1000);
        }
      }
    }

    // ==================== L√ìGICA DE SECUENCIA ====================

    function initDragAndDrop() {
      const container = document.getElementById('sequence-container');
      if (!container) return;

      let draggedItem = null;

      container.querySelectorAll('.sequence-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('opacity-50');
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('opacity-50');
          updateSequenceNumbers();
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(container, e.clientY);
          if (afterElement) {
            container.insertBefore(draggedItem, afterElement);
          } else {
            container.appendChild(draggedItem);
          }
        });
      });
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll('.sequence-item:not(.opacity-50)')];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateSequenceNumbers() {
      const items = document.querySelectorAll('.sequence-item');
      items.forEach((item, index) => {
        item.querySelector('span').textContent = index + 1;
      });
    }

    function checkSequence() {
      const items = document.querySelectorAll('.sequence-item');
      const userOrder = [...items].map(item => item.dataset.stop);
      const correctOrder = gameState.currentChallenge.correctOrder;
      
      const isCorrect = JSON.stringify(userOrder) === JSON.stringify(correctOrder);
      
      items.forEach((item, index) => {
        if (userOrder[index] === correctOrder[index]) {
          item.classList.add('correct');
        } else {
          item.classList.add('incorrect');
        }
      });

      setTimeout(() => {
        handleCorrectAnswer(isCorrect);
      }, 1000);
    }

    // ==================== L√ìGICA DE PAREJAS ====================

    function selectLine(lineNumber) {
      document.querySelectorAll('[id^="line-"]').forEach(el => el.classList.remove('selected'));
      document.getElementById(`line-${lineNumber}`).classList.add('selected');
      gameState.selectedLine = lineNumber;
    }

    function selectDestination(destination) {
      if (!gameState.selectedLine) {
        showToast('‚ö†Ô∏è Primero selecciona una l√≠nea');
        return;
      }

      const pair = gameState.currentChallenge.pairs.find(p => p.line === gameState.selectedLine);
      const isCorrect = pair && pair.destination === destination;

      const lineEl = document.getElementById(`line-${gameState.selectedLine}`);
      const destEl = document.getElementById(`dest-${destination.replace(/\s+/g, '-')}`);

      if (isCorrect) {
        lineEl.classList.add('correct');
        destEl.classList.add('correct');
        lineEl.disabled = true;
        destEl.disabled = true;
        
        if (!gameState.pairsMatched) gameState.pairsMatched = [];
        gameState.pairsMatched.push(gameState.selectedLine);
        document.getElementById('pairs-matched').textContent = gameState.pairsMatched.length;

        if (gameState.pairsMatched.length === gameState.currentChallenge.pairs.length) {
          setTimeout(() => handleCorrectAnswer(true), 500);
        }
      } else {
        lineEl.classList.add('incorrect');
        destEl.classList.add('incorrect');
        setTimeout(() => {
          lineEl.classList.remove('incorrect', 'selected');
          destEl.classList.remove('incorrect');
        }, 500);
      }

      gameState.selectedLine = null;
    }

    // ==================== COMPROBACI√ìN DE RESPUESTAS ====================

    function checkAnswer(answer) {
      const challenge = gameState.currentChallenge;
      const isCorrect = answer === challenge.answer || answer === challenge.answer.toString();
      
      const buttons = document.querySelectorAll('.challenge-card');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent.includes(challenge.answer)) {
          btn.classList.add('correct');
        } else if (btn.textContent.includes(answer)) {
          if (!isCorrect) btn.classList.add('incorrect');
        }
      });

      setTimeout(() => handleCorrectAnswer(isCorrect), 800);
    }

    function handleCorrectAnswer(isCorrect) {
      stopTimer();

      if (isCorrect) {
        const timeBonus = Math.floor(gameState.timeLeft * 2);
        const points = 100 + timeBonus;
        gameState.score += points;
        gameState.streak++;
        gameState.correctAnswers++;
        gameState.bestStreak = Math.max(gameState.bestStreak, gameState.streak);
        
        showToast(`‚úÖ ¬°Correcto! +${points} puntos`);
      } else {
        gameState.streak = 0;
        showToast('‚ùå Incorrecto');
      }

      updateGameUI();

      setTimeout(() => {
        if (gameState.round < gameState.totalRounds) {
          nextRound();
        } else {
          showResults();
        }
      }, 1500);
    }

    // ==================== CONTROL DE RONDAS ====================

    function nextRound() {
      gameState.round++;
      gameState.currentChallenge = gameState.challenges[gameState.round - 1];
      gameState.timeLeft = gameState.currentChallenge.timeLimit;

      updateGameUI();
      renderChallenge(gameState.currentChallenge);
      startTimer();
    }

    function updateGameUI() {
      document.getElementById('game-score').textContent = gameState.score;
      document.getElementById('round-display').textContent = `${gameState.round}/${gameState.totalRounds}`;
      document.getElementById('current-streak').textContent = gameState.streak;
    }

    // ==================== TEMPORIZADOR ====================

    function startTimer() {
      const timerBar = document.getElementById('timer-bar');
      const totalTime = gameState.currentChallenge.timeLimit;
      
      gameState.timerInterval = setInterval(() => {
        gameState.timeLeft -= 0.1;
        const percentage = (gameState.timeLeft / totalTime) * 100;
        timerBar.style.width = `${Math.max(0, percentage)}%`;
        
        if (gameState.timeLeft <= 0) {
          stopTimer();
          handleCorrectAnswer(false);
        }
      }, 100);
    }

    function stopTimer() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
    }

    // ==================== RESULTADOS ====================

    function showResults() {
      stopTimer();
      
      document.getElementById('result-score').textContent = gameState.score;
      document.getElementById('result-correct').textContent = gameState.correctAnswers;
      document.getElementById('result-streak').textContent = gameState.bestStreak;

      let message = '';
      if (gameState.score >= 800) {
        message = 'üèÜ ¬°Experto Total de Vitrasa!';
      } else if (gameState.score >= 500) {
        message = 'üåü ¬°Excelente Trabajo!';
      } else if (gameState.score >= 300) {
        message = 'üëç ¬°Buen Esfuerzo!';
      } else {
        message = 'üí™ ¬°Sigue Practicando!';
      }
      document.getElementById('result-message').textContent = message;

      if (currentUser) {
        saveScore({
          score: gameState.score,
          bestStreak: gameState.bestStreak
        });
      }

      showScreen('screen-results');
    }

    // ==================== UTILIDADES ====================

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateOptions(correct, type) {
      const correctNum = parseFloat(correct);
      let options = [correct];
      
      while (options.length < 4) {
        let variation;
        if (type === 'money') {
          variation = (correctNum + (Math.random() * 4 - 2)).toFixed(2);
        } else {
          variation = Math.floor(correctNum + Math.random() * 10 - 5).toString();
        }
        if (!options.includes(variation) && parseFloat(variation) > 0) {
          options.push(variation);
        }
      }
      
      return shuffleArray(options);
    }

    // ==================== INICIALIZACI√ìN ====================

    document.addEventListener('DOMContentLoaded', () => {
      checkSession();
      updateLeaderboard();
      updatePlayerStats();

      // Event listeners
      document.getElementById('show-auth-btn')?.addEventListener('click', () => showAuthModal('signup'));
      
      document.getElementById('auth-submit-btn')?.addEventListener('click', async () => {
        const username = document.getElementById('auth-username').value.trim();
        const password = document.getElementById('auth-password').value;
        
        if (authMode === 'signup') {
          await signupUser(username, password);
        } else {
          await loginUser(username, password);
        }
      });

      document.getElementById('auth-switch-btn')?.addEventListener('click', () => {
        const newMode = authMode === 'signup' ? 'login' : 'signup';
        showAuthModal(newMode);
      });

      document.getElementById('logout-btn')?.addEventListener('click', logout);
      document.getElementById('delete-account-btn')?.addEventListener('click', showDeleteModal);
      document.getElementById('cancel-delete-btn')?.addEventListener('click', hideDeleteModal);
      document.getElementById('confirm-delete-btn')?.addEventListener('click', deleteAccount);

      document.getElementById('auth-password')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('auth-submit-btn').click();
        }
      });
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7b7f4451acd929',t:'MTc3MDA1NDI3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
